"""PDF report generator for pentest scan results.

Uses ReportLab to produce a professional multi-page PDF with cover page,
executive summary, and severity-sorted findings table.
"""
from io import BytesIO
from datetime import datetime

from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import mm, cm
from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
from reportlab.platypus import (
    SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak
)


# Severity sort order: most severe first
SEVERITY_ORDER = {
    'critical': 0,
    'high': 1,
    'medium': 2,
    'low': 3,
    'info': 4,
    'pass': 5,
}

# Severity colors for table cells
SEVERITY_COLORS = {
    'critical': colors.HexColor('#dc2626'),
    'high': colors.HexColor('#ef4444'),
    'medium': colors.HexColor('#f59e0b'),
    'low': colors.HexColor('#6b7280'),
    'info': colors.HexColor('#9ca3af'),
    'pass': colors.HexColor('#22c55e'),
}

SEVERITY_TEXT_COLORS = {
    'critical': colors.white,
    'high': colors.white,
    'medium': colors.black,
    'low': colors.white,
    'info': colors.black,
    'pass': colors.white,
}


def _build_styles():
    """Create custom paragraph styles for the report."""
    styles = getSampleStyleSheet()

    styles.add(ParagraphStyle(
        'CoverTitle',
        parent=styles['Title'],
        fontSize=28,
        leading=34,
        textColor=colors.HexColor('#1a1a2e'),
        spaceAfter=12,
        alignment=TA_CENTER,
    ))
    styles.add(ParagraphStyle(
        'CoverSubtitle',
        parent=styles['Normal'],
        fontSize=14,
        leading=18,
        textColor=colors.HexColor('#4a4a6a'),
        alignment=TA_CENTER,
        spaceAfter=6,
    ))
    styles.add(ParagraphStyle(
        'SectionHeading',
        parent=styles['Heading1'],
        fontSize=16,
        leading=20,
        textColor=colors.HexColor('#1a1a2e'),
        spaceBefore=16,
        spaceAfter=10,
        borderWidth=0,
        borderPadding=0,
    ))
    styles.add(ParagraphStyle(
        'CellText',
        parent=styles['Normal'],
        fontSize=8,
        leading=10,
        wordWrap='CJK',
    ))
    styles.add(ParagraphStyle(
        'CellTextBold',
        parent=styles['Normal'],
        fontSize=8,
        leading=10,
        wordWrap='CJK',
        fontName='Helvetica-Bold',
    ))
    styles.add(ParagraphStyle(
        'RiskHigh',
        parent=styles['Title'],
        fontSize=24,
        textColor=colors.HexColor('#dc2626'),
        alignment=TA_CENTER,
    ))
    styles.add(ParagraphStyle(
        'RiskMedium',
        parent=styles['Title'],
        fontSize=24,
        textColor=colors.HexColor('#f59e0b'),
        alignment=TA_CENTER,
    ))
    styles.add(ParagraphStyle(
        'RiskLow',
        parent=styles['Title'],
        fontSize=24,
        textColor=colors.HexColor('#22c55e'),
        alignment=TA_CENTER,
    ))
    return styles


def _compute_risk_rating(findings):
    """Determine overall risk rating from findings severities."""
    sev_counts = {}
    for f in findings:
        sev = f.get('severity', 'info')
        sev_counts[sev] = sev_counts.get(sev, 0) + 1

    critical = sev_counts.get('critical', 0)
    high = sev_counts.get('high', 0)
    medium = sev_counts.get('medium', 0)

    if critical > 0:
        return 'CRITICAL', 'RiskHigh'
    elif high > 0:
        return 'HIGH', 'RiskHigh'
    elif medium > 0:
        return 'MEDIUM', 'RiskMedium'
    else:
        return 'LOW', 'RiskLow'


def _build_cover_page(scan, findings, styles):
    """Build cover page flowables."""
    elements = []
    elements.append(Spacer(1, 60 * mm))

    elements.append(Paragraph('SECURITY SCAN REPORT', styles['CoverTitle']))
    elements.append(Spacer(1, 8 * mm))
    elements.append(Paragraph('ShopHosting Security Dashboard', styles['CoverSubtitle']))
    elements.append(Spacer(1, 20 * mm))

    # Target info
    target_url = scan.get('target_url', 'N/A')
    profile = (scan.get('scan_profile') or 'N/A').upper()
    completed = scan.get('completed_at', 'N/A')
    elements.append(Paragraph(f'Target: {target_url}', styles['CoverSubtitle']))
    elements.append(Paragraph(f'Profile: {profile}', styles['CoverSubtitle']))
    elements.append(Paragraph(f'Date: {completed}', styles['CoverSubtitle']))
    elements.append(Spacer(1, 15 * mm))

    # Overall risk rating
    rating, rating_style = _compute_risk_rating(findings)
    elements.append(Paragraph('Overall Risk Rating', styles['CoverSubtitle']))
    elements.append(Paragraph(rating, styles[rating_style]))

    elements.append(PageBreak())
    return elements


def _build_executive_summary(scan, findings, styles):
    """Build executive summary page with stats tables."""
    elements = []
    elements.append(Paragraph('Executive Summary', styles['SectionHeading']))

    # Pass / Warn / Fail summary
    summary_data = [
        ['PASS', 'WARN', 'FAIL'],
        [
            str(scan.get('pass_count', 0)),
            str(scan.get('warn_count', 0)),
            str(scan.get('fail_count', 0)),
        ],
    ]
    summary_table = Table(summary_data, colWidths=[50 * mm, 50 * mm, 50 * mm])
    summary_table.setStyle(TableStyle([
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 10),
        ('FONTSIZE', (0, 1), (-1, 1), 18),
        ('TEXTCOLOR', (0, 1), (0, 1), colors.HexColor('#22c55e')),
        ('TEXTCOLOR', (1, 1), (1, 1), colors.HexColor('#f59e0b')),
        ('TEXTCOLOR', (2, 1), (2, 1), colors.HexColor('#dc2626')),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#f3f4f6')),
        ('TOPPADDING', (0, 0), (-1, -1), 8),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
    ]))
    elements.append(summary_table)
    elements.append(Spacer(1, 10 * mm))

    # Severity breakdown
    sev_counts = {}
    for f in findings:
        sev = f.get('severity', 'info')
        sev_counts[sev] = sev_counts.get(sev, 0) + 1

    elements.append(Paragraph('Severity Breakdown', styles['SectionHeading']))
    sev_data = [
        ['Severity', 'Count'],
        ['Critical', str(sev_counts.get('critical', 0))],
        ['High', str(sev_counts.get('high', 0))],
        ['Medium', str(sev_counts.get('medium', 0))],
        ['Low', str(sev_counts.get('low', 0))],
        ['Info', str(sev_counts.get('info', 0))],
    ]
    sev_table = Table(sev_data, colWidths=[80 * mm, 40 * mm])
    sev_style_cmds = [
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('ALIGN', (1, 0), (1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, -1), 10),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#f3f4f6')),
        ('TOPPADDING', (0, 0), (-1, -1), 6),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
    ]
    # Color-code severity rows
    sev_row_colors = [
        (1, SEVERITY_COLORS.get('critical')),
        (2, SEVERITY_COLORS.get('high')),
        (3, SEVERITY_COLORS.get('medium')),
        (4, SEVERITY_COLORS.get('low')),
        (5, SEVERITY_COLORS.get('info')),
    ]
    for row_idx, bg_color in sev_row_colors:
        sev_style_cmds.append(('BACKGROUND', (0, row_idx), (0, row_idx), bg_color))
        text_color = SEVERITY_TEXT_COLORS.get(
            ['critical', 'high', 'medium', 'low', 'info'][row_idx - 1], colors.black
        )
        sev_style_cmds.append(('TEXTCOLOR', (0, row_idx), (0, row_idx), text_color))

    sev_table.setStyle(TableStyle(sev_style_cmds))
    elements.append(sev_table)
    elements.append(Spacer(1, 10 * mm))

    # Tools used
    parsed_tools = scan.get('parsed_tools', [])
    if parsed_tools:
        elements.append(Paragraph('Tools Used', styles['SectionHeading']))
        tools_str = ', '.join(t.upper() for t in parsed_tools)
        elements.append(Paragraph(tools_str, styles['Normal']))
        elements.append(Spacer(1, 5 * mm))

    # Scan timestamps
    elements.append(Paragraph('Scan Details', styles['SectionHeading']))
    parsed_results = scan.get('parsed_results', {})
    duration = parsed_results.get('duration_seconds', 0)
    detail_data = [
        ['Started', str(scan.get('started_at', 'N/A'))],
        ['Completed', str(scan.get('completed_at', 'N/A'))],
        ['Duration', f'{duration:.1f}s' if duration else 'N/A'],
        ['Target URL', str(scan.get('target_url', 'N/A'))],
        ['Profile', str(scan.get('scan_profile', 'N/A')).upper()],
    ]
    detail_table = Table(detail_data, colWidths=[40 * mm, 120 * mm])
    detail_table.setStyle(TableStyle([
        ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, -1), 9),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
        ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#f3f4f6')),
        ('TOPPADDING', (0, 0), (-1, -1), 5),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 5),
        ('LEFTPADDING', (0, 0), (-1, -1), 6),
    ]))
    elements.append(detail_table)

    elements.append(PageBreak())
    return elements


def _build_findings_table(findings, styles):
    """Build the findings table sorted by severity."""
    elements = []
    elements.append(Paragraph(f'Findings ({len(findings)})', styles['SectionHeading']))

    if not findings:
        elements.append(Paragraph('No findings â€” all checks passed.', styles['Normal']))
        return elements

    # Sort by severity
    sorted_findings = sorted(
        findings,
        key=lambda f: SEVERITY_ORDER.get(f.get('severity', 'info'), 99)
    )

    cell_style = styles['CellText']
    cell_bold = styles['CellTextBold']

    # Column widths: #, Tool, Severity, Title, Description, Solution
    col_widths = [8 * mm, 20 * mm, 18 * mm, 45 * mm, 50 * mm, 40 * mm]

    # Header row
    header = [
        Paragraph('<b>#</b>', cell_bold),
        Paragraph('<b>Tool</b>', cell_bold),
        Paragraph('<b>Severity</b>', cell_bold),
        Paragraph('<b>Title</b>', cell_bold),
        Paragraph('<b>Description</b>', cell_bold),
        Paragraph('<b>Solution</b>', cell_bold),
    ]
    table_data = [header]

    for idx, finding in enumerate(sorted_findings, 1):
        sev = finding.get('severity', 'info')
        tool = finding.get('tool', '-')
        title = finding.get('title', '-')
        desc = finding.get('description', '-')
        solution = finding.get('solution', '-')

        row = [
            Paragraph(str(idx), cell_style),
            Paragraph(str(tool).upper(), cell_style),
            Paragraph(str(sev).upper(), cell_bold),
            Paragraph(str(title), cell_style),
            Paragraph(str(desc), cell_style),
            Paragraph(str(solution), cell_style),
        ]
        table_data.append(row)

    table = Table(table_data, colWidths=col_widths, repeatRows=1)

    style_cmds = [
        ('ALIGN', (0, 0), (0, -1), 'CENTER'),
        ('ALIGN', (2, 0), (2, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('FONTSIZE', (0, 0), (-1, -1), 8),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#1a1a2e')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
        ('TOPPADDING', (0, 0), (-1, -1), 4),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
        ('LEFTPADDING', (0, 0), (-1, -1), 4),
        ('RIGHTPADDING', (0, 0), (-1, -1), 4),
    ]

    # Alternate row backgrounds and color-code severity cells
    for i, finding in enumerate(sorted_findings, 1):
        sev = finding.get('severity', 'info')
        # Severity cell background
        bg = SEVERITY_COLORS.get(sev, colors.HexColor('#9ca3af'))
        txt = SEVERITY_TEXT_COLORS.get(sev, colors.black)
        style_cmds.append(('BACKGROUND', (2, i), (2, i), bg))
        style_cmds.append(('TEXTCOLOR', (2, i), (2, i), txt))
        # Alternating row background (light gray for even rows)
        if i % 2 == 0:
            style_cmds.append(('BACKGROUND', (0, i), (1, i), colors.HexColor('#f9fafb')))
            style_cmds.append(('BACKGROUND', (3, i), (-1, i), colors.HexColor('#f9fafb')))

    table.setStyle(TableStyle(style_cmds))
    elements.append(table)
    return elements


def _footer(canvas, doc):
    """Add footer with page number and generation timestamp."""
    canvas.saveState()
    canvas.setFont('Helvetica', 7)
    canvas.setFillColor(colors.HexColor('#6b7280'))
    page_text = f'Page {doc.page}'
    canvas.drawRightString(A4[0] - 15 * mm, 10 * mm, page_text)
    canvas.drawString(15 * mm, 10 * mm, f'Generated: {datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")}')
    canvas.drawCentredString(A4[0] / 2, 10 * mm, 'ShopHosting Security Dashboard')
    canvas.restoreState()


def generate_pentest_pdf(scan):
    """Generate a PDF report for a pentest scan.

    Args:
        scan: dict with keys like id, target_url, scan_profile, status,
              pass_count, warn_count, fail_count, started_at, completed_at,
              parsed_results (dict with 'findings' list, 'duration_seconds'),
              parsed_tools (list of tool name strings).

    Returns:
        PDF file contents as bytes.
    """
    buf = BytesIO()
    doc = SimpleDocTemplate(
        buf,
        pagesize=A4,
        topMargin=15 * mm,
        bottomMargin=20 * mm,
        leftMargin=15 * mm,
        rightMargin=15 * mm,
        title=f'Pentest Scan #{scan.get("id", "")} Report',
        author='ShopHosting Security Dashboard',
    )

    styles = _build_styles()
    parsed_results = scan.get('parsed_results', {})
    findings = parsed_results.get('findings', [])

    elements = []
    elements.extend(_build_cover_page(scan, findings, styles))
    elements.extend(_build_executive_summary(scan, findings, styles))
    elements.extend(_build_findings_table(findings, styles))

    doc.build(elements, onFirstPage=_footer, onLaterPages=_footer)
    return buf.getvalue()
