{% extends "base.html" %}

{% block title %}PENTEST SCAN #{{ scan.id }} // REPORT{% endblock %}

{% block content %}
<div class="report-header stagger-in">
    <a href="/pentest" class="report-header__back">&lt; BACK TO SCANS</a>
    <div class="report-header__title">
        <span class="report-header__id">SCAN #{{ scan.id }}</span>
        <span class="badge badge--{{ 'green' if scan.status == 'completed' else 'amber' if scan.status == 'running' else 'crimson' if scan.status == 'failed' else 'default' }}">{{ scan.status | upper }}</span>
        <span class="badge badge--cyan">{{ scan.scan_profile | upper }}</span>
        {% if scan.status == 'completed' %}
        <a href="/pentest/{{ scan.id }}/pdf" class="btn btn--cyan" style="float:right">DOWNLOAD PDF</a>
        {% endif %}
    </div>
</div>

<!-- Summary Stats -->
<div class="grid-4 stagger-in">
    <div class="panel">
        <div class="panel__body" style="text-align:center">
            <div class="stat-value text-phosphor">{{ scan.pass_count or 0 }}</div>
            <div class="stat-label">PASS</div>
        </div>
    </div>
    <div class="panel {{ 'panel--amber' if (scan.warn_count or 0) > 0 else '' }}">
        <div class="panel__body" style="text-align:center">
            <div class="stat-value text-amber">{{ scan.warn_count or 0 }}</div>
            <div class="stat-label">WARN</div>
        </div>
    </div>
    <div class="panel {{ 'panel--crimson' if (scan.fail_count or 0) > 0 else '' }}">
        <div class="panel__body" style="text-align:center">
            <div class="stat-value text-crimson">{{ scan.fail_count or 0 }}</div>
            <div class="stat-label">FAIL</div>
        </div>
    </div>
    <div class="panel">
        <div class="panel__body" style="text-align:center">
            <div class="stat-value">{{ scan.parsed_results.get('duration_seconds', 0) | round(1) }}s</div>
            <div class="stat-label">DURATION</div>
        </div>
    </div>
</div>

<!-- Scan Metadata -->
<div class="panel stagger-in">
    <div class="panel__header">SCAN METADATA</div>
    <div class="panel__body">
        <div class="report-meta">
            <div class="report-meta__item"><span class="report-meta__label">TARGET</span><span class="report-meta__value">{{ scan.target_url }}</span></div>
            <div class="report-meta__item"><span class="report-meta__label">PROFILE</span><span class="report-meta__value">{{ scan.scan_profile | upper }}</span></div>
            <div class="report-meta__item"><span class="report-meta__label">STARTED</span><span class="report-meta__value">{{ scan.started_at or 'N/A' }}</span></div>
            <div class="report-meta__item"><span class="report-meta__label">COMPLETED</span><span class="report-meta__value">{{ scan.completed_at or 'N/A' }}</span></div>
        </div>
        {% if scan.parsed_tools %}
        <div style="margin-top:0.75rem">
            <span class="report-meta__label" style="margin-right:0.5rem">TOOLS USED</span>
            {% for tool in scan.parsed_tools %}
            <span class="badge badge--cyan">{{ tool | upper }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Findings Table -->
{% set findings = scan.parsed_results.get('findings', []) %}
{% if findings %}
<div class="panel stagger-in">
    <div class="panel__header">
        FINDINGS ({{ findings | length }})
        <div class="report-filter" style="float:right">
            <select class="input" id="severity-filter" onchange="filterFindings()" style="width:auto;padding:0.2rem 0.5rem;font-size:0.75rem">
                <option value="all">ALL SEVERITIES</option>
                <option value="critical">CRITICAL</option>
                <option value="high">HIGH</option>
                <option value="medium">MEDIUM</option>
                <option value="low">LOW</option>
                <option value="info">INFO</option>
            </select>
        </div>
    </div>
    <div class="panel__body">
        <table class="data-table" id="findings-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>TOOL</th>
                    <th>SEVERITY</th>
                    <th>TITLE</th>
                    <th>DESCRIPTION</th>
                    <th>URL</th>
                    <th>SOLUTION</th>
                </tr>
            </thead>
            <tbody>
                {% for finding in findings %}
                <tr class="finding-row" data-severity="{{ finding.severity }}">
                    <td>{{ loop.index }}</td>
                    <td><span class="badge badge--cyan">{{ finding.tool | upper }}</span></td>
                    <td><span class="badge badge--{{ 'crimson' if finding.severity in ('critical','high') else 'amber' if finding.severity == 'medium' else 'default' }}">{{ finding.severity | upper }}</span></td>
                    <td>{{ finding.title }}</td>
                    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis" title="{{ finding.description }}">{{ finding.description }}</td>
                    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis" title="{{ finding.get('url', '') }}">{{ finding.get('url', '-') }}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="{{ finding.get('solution', '') }}">{{ finding.get('solution', '-') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Severity Breakdown -->
<div class="grid-4 stagger-in" style="margin-bottom:1rem">
    {% set sev_counts = {} %}
    {% for f in findings %}
        {% if sev_counts.update({f.severity: sev_counts.get(f.severity, 0) + 1}) %}{% endif %}
    {% endfor %}
    <div class="panel"><div class="panel__body" style="text-align:center"><div class="stat-value text-crimson">{{ sev_counts.get('critical', 0) + sev_counts.get('high', 0) }}</div><div class="stat-label">CRITICAL/HIGH</div></div></div>
    <div class="panel"><div class="panel__body" style="text-align:center"><div class="stat-value text-amber">{{ sev_counts.get('medium', 0) }}</div><div class="stat-label">MEDIUM</div></div></div>
    <div class="panel"><div class="panel__body" style="text-align:center"><div class="stat-value text-cyan">{{ sev_counts.get('low', 0) }}</div><div class="stat-label">LOW</div></div></div>
    <div class="panel"><div class="panel__body" style="text-align:center"><div class="stat-value">{{ sev_counts.get('info', 0) + sev_counts.get('pass', 0) }}</div><div class="stat-label">INFO/PASS</div></div></div>
</div>
{% else %}
{% if scan.status == 'completed' %}
<div class="panel stagger-in">
    <div class="panel__header">SCAN RESULTS</div>
    <div class="panel__body">
        <div class="empty-state text-phosphor">NO FINDINGS - ALL CHECKS PASSED</div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Raw Output per Tool -->
{% set raw_output = scan.parsed_results.get('raw_output', {}) %}
{% if raw_output %}
<div class="panel stagger-in">
    <div class="panel__header report-collapsible" onclick="this.parentElement.classList.toggle('panel--collapsed')">
        RAW TOOL OUTPUT <span class="report-collapsible__icon">[-]</span>
    </div>
    <div class="panel__body">
        {% for tool_name, tool_output in raw_output.items() %}
        <div style="margin-bottom:1rem">
            <span class="badge badge--cyan" style="margin-bottom:0.5rem;display:inline-block">{{ tool_name | upper }}</span>
            <div class="terminal" style="max-height:300px;overflow-y:auto">
                <pre style="margin:0;white-space:pre-wrap;word-break:break-all">{{ tool_output | tojson(indent=2) }}</pre>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Full Raw JSON -->
{% if scan.parsed_results %}
<div class="panel panel--collapsed stagger-in">
    <div class="panel__header report-collapsible" onclick="this.parentElement.classList.toggle('panel--collapsed')">
        FULL JSON RESPONSE <span class="report-collapsible__icon">[-]</span>
    </div>
    <div class="panel__body">
        <div class="terminal" style="max-height:400px;overflow-y:auto">
            <pre style="margin:0;white-space:pre-wrap;word-break:break-all">{{ scan.results }}</pre>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterFindings() {
    const filter = document.getElementById('severity-filter').value;
    document.querySelectorAll('.finding-row').forEach(row => {
        if (filter === 'all' || row.dataset.severity === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
