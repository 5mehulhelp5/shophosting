{% extends "base.html" %}

{% block title %}Battle Results - Speed Battle{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Battle Results Arena */
    .results-arena {
        min-height: calc(100vh - 200px);
        padding: 40px 20px;
        position: relative;
        overflow: hidden;
    }

    /* Animated grid background */
    .results-arena::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
        background-size: 60px 60px;
        animation: gridPulse 4s ease-in-out infinite;
    }

    @keyframes gridPulse {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    /* Dynamic glow orbs based on winner */
    .glow-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        pointer-events: none;
    }

    .glow-orb-winner {
        width: 600px;
        height: 600px;
        top: -200px;
        left: 50%;
        transform: translateX(-50%);
        animation: winnerGlow 3s ease-in-out infinite;
    }

    .winner-challenger .glow-orb-winner {
        background: radial-gradient(circle, rgba(0, 212, 255, 0.2) 0%, transparent 70%);
    }

    .winner-opponent .glow-orb-winner {
        background: radial-gradient(circle, rgba(255, 107, 107, 0.15) 0%, transparent 70%);
    }

    .winner-tie .glow-orb-winner {
        background: radial-gradient(circle, rgba(91, 91, 214, 0.15) 0%, transparent 70%);
    }

    @keyframes winnerGlow {
        0%, 100% { opacity: 0.8; transform: translateX(-50%) scale(1); }
        50% { opacity: 1; transform: translateX(-50%) scale(1.1); }
    }

    .results-content {
        position: relative;
        z-index: 10;
        max-width: 1100px;
        margin: 0 auto;
    }

    /* ===== SCANNING STATE ===== */
    .scanning-container {
        text-align: center;
        padding: 80px 20px;
    }

    .scanning-animation {
        width: 160px;
        height: 160px;
        margin: 0 auto 40px;
        position: relative;
    }

    .scanning-ring {
        position: absolute;
        inset: 0;
        border: 3px solid transparent;
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: scanSpin 1s linear infinite;
    }

    .scanning-ring:nth-child(2) {
        inset: 15px;
        border-top-color: var(--accent-blue);
        animation-duration: 1.5s;
        animation-direction: reverse;
    }

    .scanning-ring:nth-child(3) {
        inset: 30px;
        border-top-color: var(--accent-indigo);
        animation-duration: 2s;
    }

    @keyframes scanSpin {
        to { transform: rotate(360deg); }
    }

    .scanning-core {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: corePulse 1.5s ease-in-out infinite;
    }

    .scanning-core svg {
        width: 28px;
        height: 28px;
        color: var(--bg-deepest);
    }

    @keyframes corePulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
        50% { box-shadow: 0 0 0 20px rgba(0, 212, 255, 0); }
    }

    .scanning-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    .scanning-subtitle {
        font-family: 'Exo 2', sans-serif;
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 40px;
    }

    .scanning-progress {
        max-width: 400px;
        margin: 0 auto;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .scanning-progress-bar {
        height: 100%;
        width: 60%;
        background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue), var(--accent-indigo));
        background-size: 200% 100%;
        animation: progressShimmer 1.5s ease-in-out infinite;
        border-radius: 3px;
    }

    @keyframes progressShimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .scanning-urls {
        display: flex;
        justify-content: center;
        gap: 60px;
        margin-top: 48px;
    }

    .scanning-url {
        text-align: center;
    }

    .scanning-url-label {
        font-family: 'Exo 2', sans-serif;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 8px;
    }

    .scanning-url-label.challenger { color: var(--accent-cyan); }
    .scanning-url-label.opponent { color: #ff6b6b; }

    .scanning-url-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
        color: var(--text-secondary);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* ===== FAILED STATE ===== */
    .failed-container {
        text-align: center;
        padding: 80px 20px;
    }

    .failed-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 32px;
        background: rgba(239, 68, 68, 0.1);
        border: 2px solid rgba(239, 68, 68, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .failed-icon svg {
        width: 48px;
        height: 48px;
        color: var(--error);
    }

    .failed-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        color: var(--error);
        margin-bottom: 16px;
    }

    .failed-message {
        font-family: 'Exo 2', sans-serif;
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 32px;
    }

    .retry-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 16px 32px;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border: none;
        border-radius: 12px;
        font-family: 'Orbitron', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--bg-deepest);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .retry-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0, 136, 255, 0.3);
    }

    /* ===== COMPLETED STATE ===== */

    /* Victory/Defeat Header */
    .result-header {
        text-align: center;
        margin-bottom: 60px;
        animation: headerReveal 0.8s ease-out;
    }

    @keyframes headerReveal {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-outcome {
        font-family: 'Orbitron', sans-serif;
        font-size: clamp(3rem, 10vw, 6rem);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 8px;
        text-shadow: 0 0 60px currentColor;
    }

    .winner-challenger .result-outcome {
        background: linear-gradient(135deg, #00ff88 0%, #00d4ff 50%, #00ff88 100%);
        background-size: 200% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: victoryShimmer 2s ease-in-out infinite;
    }

    .winner-opponent .result-outcome {
        color: #ff6b6b;
    }

    .winner-tie .result-outcome {
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    @keyframes victoryShimmer {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    .result-margin {
        font-family: 'Exo 2', sans-serif;
        font-size: 1.2rem;
        color: var(--text-secondary);
    }

    /* Battle Arena Display */
    .battle-display {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 24px;
        align-items: center;
        margin-bottom: 60px;
        animation: displayReveal 0.8s ease-out 0.2s both;
    }

    @keyframes displayReveal {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .fighter-card {
        background: linear-gradient(180deg, rgba(24, 24, 28, 0.9) 0%, rgba(17, 17, 20, 0.95) 100%);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        padding: 40px 32px;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .fighter-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
    }

    .fighter-card.challenger::before {
        background: linear-gradient(90deg, transparent 0%, var(--accent-cyan) 50%, transparent 100%);
    }

    .fighter-card.opponent::before {
        background: linear-gradient(90deg, transparent 0%, #ff6b6b 50%, transparent 100%);
    }

    .fighter-card.winner {
        border-color: rgba(0, 255, 136, 0.3);
        box-shadow: 0 0 40px rgba(0, 255, 136, 0.1);
    }

    .fighter-card.winner::after {
        content: 'WINNER';
        position: absolute;
        top: 20px;
        right: -35px;
        background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
        color: var(--bg-deepest);
        font-family: 'Orbitron', sans-serif;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 6px 40px;
        transform: rotate(45deg);
        letter-spacing: 0.1em;
    }

    .fighter-label {
        font-family: 'Exo 2', sans-serif;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        margin-bottom: 8px;
    }

    .fighter-card.challenger .fighter-label {
        color: var(--accent-cyan);
    }

    .fighter-card.opponent .fighter-label {
        color: #ff6b6b;
    }

    .fighter-url {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-bottom: 24px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .fighter-score {
        font-family: 'Orbitron', sans-serif;
        font-size: 5rem;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 16px;
    }

    .fighter-card.challenger .fighter-score {
        background: linear-gradient(180deg, #fff 0%, var(--accent-cyan) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .fighter-card.opponent .fighter-score {
        background: linear-gradient(180deg, #fff 0%, #ff6b6b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .fighter-tier {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 100px;
        font-family: 'Exo 2', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .tier-green {
        background: rgba(0, 255, 136, 0.15);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .tier-blue {
        background: rgba(0, 136, 255, 0.15);
        color: var(--accent-blue);
        border: 1px solid rgba(0, 136, 255, 0.3);
    }

    .tier-yellow {
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .tier-red {
        background: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    /* VS Badge */
    .vs-badge-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .vs-badge-large {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, rgba(91, 91, 214, 0.2) 0%, rgba(0, 136, 255, 0.2) 100%);
        border: 2px solid rgba(91, 91, 214, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-indigo);
    }

    /* Round Breakdown */
    .rounds-section {
        margin-bottom: 60px;
        animation: roundsReveal 0.8s ease-out 0.4s both;
    }

    @keyframes roundsReveal {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .rounds-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.3rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-align: center;
        margin-bottom: 32px;
        color: var(--text-primary);
    }

    .rounds-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .round-row {
        display: grid;
        grid-template-columns: 1fr 80px 100px 100px 80px;
        gap: 16px;
        align-items: center;
        padding: 20px 24px;
        background: rgba(24, 24, 28, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .round-row:hover {
        background: rgba(24, 24, 28, 0.9);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .round-name {
        font-family: 'Exo 2', sans-serif;
        font-weight: 600;
        color: var(--text-primary);
    }

    .round-weight {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: var(--text-tertiary);
        text-align: center;
    }

    .round-score {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        text-align: center;
    }

    .round-score.challenger { color: var(--accent-cyan); }
    .round-score.opponent { color: #ff6b6b; }
    .round-score.winner-score { text-shadow: 0 0 20px currentColor; }

    .round-result {
        text-align: center;
    }

    .round-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 100px;
        font-family: 'Exo 2', sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .round-badge.you {
        background: rgba(0, 212, 255, 0.15);
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .round-badge.them {
        background: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .round-badge.tie {
        background: rgba(113, 113, 122, 0.15);
        color: var(--text-tertiary);
        border: 1px solid rgba(113, 113, 122, 0.3);
    }

    /* Email Capture */
    .email-capture {
        background: linear-gradient(180deg, rgba(24, 24, 28, 0.9) 0%, rgba(17, 17, 20, 0.95) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        padding: 48px;
        text-align: center;
        margin-bottom: 60px;
        position: relative;
        overflow: hidden;
        animation: captureReveal 0.8s ease-out 0.6s both;
    }

    @keyframes captureReveal {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .email-capture::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent 0%, var(--accent-cyan) 20%, var(--accent-blue) 50%, var(--accent-indigo) 80%, transparent 100%);
    }

    .email-capture-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .email-capture-icon svg {
        width: 28px;
        height: 28px;
        color: var(--bg-deepest);
    }

    .email-capture-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    .email-capture-text {
        font-family: 'Exo 2', sans-serif;
        color: var(--text-secondary);
        margin-bottom: 32px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .email-form {
        display: flex;
        gap: 12px;
        max-width: 450px;
        margin: 0 auto;
    }

    .email-input {
        flex: 1;
        padding: 16px 20px;
        background: rgba(8, 8, 10, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-family: 'Exo 2', sans-serif;
        font-size: 1rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .email-input::placeholder {
        color: var(--text-muted);
    }

    .email-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
    }

    .email-submit {
        padding: 16px 28px;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border: none;
        border-radius: 12px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--bg-deepest);
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .email-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 136, 255, 0.3);
    }

    /* Share Section */
    .share-section {
        text-align: center;
        animation: shareReveal 0.8s ease-out 0.8s both;
    }

    @keyframes shareReveal {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .share-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 24px;
    }

    .share-buttons {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .share-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 14px 24px;
        background: rgba(24, 24, 28, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-family: 'Exo 2', sans-serif;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .share-btn svg {
        width: 18px;
        height: 18px;
    }

    .share-btn:hover {
        background: rgba(24, 24, 28, 1);
        border-color: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        transform: translateY(-2px);
    }

    .share-btn.twitter:hover {
        border-color: rgba(29, 161, 242, 0.5);
        color: #1da1f2;
    }

    .share-btn.facebook:hover {
        border-color: rgba(24, 119, 242, 0.5);
        color: #1877f2;
    }

    .share-btn.linkedin:hover {
        border-color: rgba(10, 102, 194, 0.5);
        color: #0a66c2;
    }

    .share-btn.copy:hover {
        border-color: rgba(0, 212, 255, 0.5);
        color: var(--accent-cyan);
    }

    /* Toast notification */
    .toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-elevated);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 12px;
        padding: 16px 28px;
        font-family: 'Exo 2', sans-serif;
        color: var(--text-primary);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .battle-display {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .vs-badge-container {
            order: -1;
        }

        .vs-badge-large {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
        }

        .fighter-score {
            font-size: 4rem;
        }
    }

    @media (max-width: 700px) {
        .round-row {
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .round-name {
            grid-column: 1 / -1;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .round-weight {
            display: none;
        }

        .email-form {
            flex-direction: column;
        }
    }

    @media (max-width: 500px) {
        .scanning-urls {
            flex-direction: column;
            gap: 24px;
        }

        .fighter-card {
            padding: 32px 24px;
        }

        .fighter-score {
            font-size: 3.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-arena {% if battle.status == 'completed' %}winner-{{ battle.winner }}{% endif %}">
    <div class="glow-orb glow-orb-winner"></div>

    <div class="results-content">
        {% if battle.status == 'pending' or battle.status == 'scanning' %}
        <!-- ===== SCANNING STATE ===== -->
        <div class="scanning-container">
            <div class="scanning-animation">
                <div class="scanning-ring"></div>
                <div class="scanning-ring"></div>
                <div class="scanning-ring"></div>
                <div class="scanning-core">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
            </div>

            <h1 class="scanning-title">Battle in Progress</h1>
            <p class="scanning-subtitle">Analyzing both sites... This may take up to a minute.</p>

            <div class="scanning-progress">
                <div class="scanning-progress-bar"></div>
            </div>

            <div class="scanning-urls">
                <div class="scanning-url">
                    <div class="scanning-url-label challenger">Challenger</div>
                    <div class="scanning-url-value">{{ battle.challenger_url }}</div>
                </div>
                <div class="scanning-url">
                    <div class="scanning-url-label opponent">Opponent</div>
                    <div class="scanning-url-value">{{ battle.opponent_url }}</div>
                </div>
            </div>
        </div>

        <script nonce="{{ csp_nonce() }}">
        function checkStatus() {
            fetch('{{ url_for("leads.speed_battle_status", battle_uid=battle.battle_uid) }}')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'completed' || data.status === 'failed') {
                        window.location.reload();
                    } else {
                        setTimeout(checkStatus, 2000);
                    }
                })
                .catch(error => {
                    console.error('Status check failed:', error);
                    setTimeout(checkStatus, 3000);
                });
        }
        checkStatus();
        </script>

        {% elif battle.status == 'failed' %}
        <!-- ===== FAILED STATE ===== -->
        <div class="failed-container">
            <div class="failed-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>
            <h1 class="failed-title">Battle Failed</h1>
            <p class="failed-message">{{ battle.error_message or 'An error occurred while scanning. Please try again.' }}</p>
            <a href="{{ url_for('leads.speed_battle') }}" class="retry-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
                </svg>
                Try Again
            </a>
        </div>

        {% else %}
        <!-- ===== COMPLETED STATE ===== -->

        <!-- Victory/Defeat Header -->
        <div class="result-header">
            <h1 class="result-outcome">
                {% if battle.winner == 'challenger' %}
                Victory!
                {% elif battle.winner == 'opponent' %}
                Defeat
                {% else %}
                It's a Tie!
                {% endif %}
            </h1>
            {% if battle.margin %}
            <p class="result-margin">
                {% if battle.winner == 'challenger' %}
                You won by {{ battle.margin }} points
                {% elif battle.winner == 'opponent' %}
                You lost by {{ battle.margin }} points
                {% endif %}
            </p>
            {% endif %}
        </div>

        <!-- Battle Display -->
        <div class="battle-display">
            <!-- Challenger Card -->
            <div class="fighter-card challenger {% if battle.winner == 'challenger' %}winner{% endif %}">
                <div class="fighter-label">Your Store</div>
                <div class="fighter-url">{{ battle.challenger_url }}</div>
                <div class="fighter-score">{{ battle.challenger_score or '-' }}</div>
                {% if challenger_tier %}
                <span class="fighter-tier tier-{{ challenger_tier.color }}">{{ challenger_tier.label }}</span>
                {% endif %}
            </div>

            <!-- VS Badge -->
            <div class="vs-badge-container">
                <div class="vs-badge-large">VS</div>
            </div>

            <!-- Opponent Card -->
            <div class="fighter-card opponent {% if battle.winner == 'opponent' %}winner{% endif %}">
                <div class="fighter-label">Competitor</div>
                <div class="fighter-url">{{ battle.opponent_url }}</div>
                <div class="fighter-score">{{ battle.opponent_score or '-' }}</div>
                {% if opponent_tier %}
                <span class="fighter-tier tier-{{ opponent_tier.color }}">{{ opponent_tier.label }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Round Breakdown -->
        {% if rounds %}
        <div class="rounds-section">
            <h2 class="rounds-title">Round Breakdown</h2>
            <div class="rounds-grid">
                {% for round in rounds %}
                <div class="round-row">
                    <div class="round-name">{{ round.name }}</div>
                    <div class="round-weight">{{ round.weight }}%</div>
                    <div class="round-score challenger {% if round.winner == 'challenger' %}winner-score{% endif %}">
                        {{ round.challenger_score }}
                    </div>
                    <div class="round-score opponent {% if round.winner == 'opponent' %}winner-score{% endif %}">
                        {{ round.opponent_score }}
                    </div>
                    <div class="round-result">
                        {% if round.winner == 'challenger' %}
                        <span class="round-badge you">You</span>
                        {% elif round.winner == 'opponent' %}
                        <span class="round-badge them">Them</span>
                        {% else %}
                        <span class="round-badge tie">Tie</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Email Capture -->
        {% if not battle.email %}
        <div class="email-capture">
            <div class="email-capture-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </div>
            <h3 class="email-capture-title">Get Your Detailed Report</h3>
            <p class="email-capture-text">Enter your email to receive a comprehensive breakdown with improvement tips.</p>
            <form id="unlock-form" class="email-form">
                <input type="email" class="email-input" id="email" name="email" placeholder="you@example.com" required>
                <button type="submit" class="email-submit">Get Report</button>
            </form>
        </div>

        <script nonce="{{ csp_nonce() }}">
        document.getElementById('unlock-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const btn = this.querySelector('.email-submit');
            btn.textContent = 'Sending...';
            btn.disabled = true;

            fetch('{{ url_for("leads.speed_battle_unlock", battle_uid=battle.battle_uid) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    btn.textContent = 'Get Report';
                    btn.disabled = false;
                } else {
                    showToast('Check your inbox for the detailed report!');
                    setTimeout(() => window.location.reload(), 1500);
                }
            })
            .catch(() => {
                btn.textContent = 'Get Report';
                btn.disabled = false;
            });
        });
        </script>
        {% endif %}

        <!-- Share Section -->
        <div class="share-section">
            <h3 class="share-title">Challenge a Friend</h3>
            <div class="share-buttons">
                <button type="button" class="share-btn twitter" data-platform="twitter">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    Twitter
                </button>
                <button type="button" class="share-btn facebook" data-platform="facebook">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Facebook
                </button>
                <button type="button" class="share-btn linkedin" data-platform="linkedin">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    LinkedIn
                </button>
                <button type="button" class="share-btn copy" data-platform="copy">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy Link
                </button>
            </div>
        </div>

        <script nonce="{{ csp_nonce() }}">
        function showToast(message) {
            let toast = document.querySelector('.toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        document.querySelectorAll('.share-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const platform = this.dataset.platform;
                const shareUrl = '{{ url_for("leads.speed_battle", ref=battle.battle_uid, _external=True) }}';
                const shareText = {% if battle.winner == 'challenger' %}'I just beat my competitor in a Speed Battle! Can you beat me?'{% else %}'I just tested my site speed in a Speed Battle. Think you can do better?'{% endif %};

                fetch('{{ url_for("leads.speed_battle_share", battle_uid=battle.battle_uid) }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platform: platform })
                });

                if (platform === 'copy') {
                    navigator.clipboard.writeText(shareUrl);
                    showToast('Link copied to clipboard!');
                } else if (platform === 'twitter') {
                    window.open('https://twitter.com/intent/tweet?url=' + encodeURIComponent(shareUrl) + '&text=' + encodeURIComponent(shareText));
                } else if (platform === 'facebook') {
                    window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl));
                } else if (platform === 'linkedin') {
                    window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(shareUrl));
                }
            });
        });
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}
