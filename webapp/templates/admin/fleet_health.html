{% extends "admin/base_admin.html" %}

{% block title %}Fleet Health{% endblock %}
{% block page_title %}Fleet Health Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Overview Cards */
    .fleet-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
        .fleet-stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .fleet-stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .fleet-stat-card {
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 24px;
        transition: all 0.2s;
    }

    .fleet-stat-card:hover {
        border-color: var(--border-accent);
        box-shadow: var(--shadow-glow);
    }

    .fleet-stat-card.warning {
        border-color: var(--warning);
        background: var(--warning-muted);
    }

    .fleet-stat-card.danger {
        border-color: var(--error);
        background: var(--error-muted);
    }

    .fleet-stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
    }

    .fleet-stat-icon.default { background: var(--info-muted); color: var(--accent-blue); }
    .fleet-stat-icon.success { background: var(--success-muted); color: var(--success); }
    .fleet-stat-icon.warning { background: var(--warning-muted); color: var(--warning); }
    .fleet-stat-icon.danger { background: var(--error-muted); color: var(--error); }

    /* Health Distribution Bar */
    .health-distribution {
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 20px 24px;
        margin-bottom: 24px;
    }

    .health-distribution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .health-distribution-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .health-distribution-legend {
        display: flex;
        gap: 24px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }

    .legend-dot.healthy { background: var(--success); }
    .legend-dot.warning { background: var(--warning); }
    .legend-dot.critical { background: var(--error); }

    .health-bar-container {
        height: 24px;
        background: var(--bg-surface);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
    }

    .health-bar-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--bg-deepest);
        transition: width 0.5s ease;
    }

    .health-bar-segment.healthy { background: var(--success); }
    .health-bar-segment.warning { background: var(--warning); }
    .health-bar-segment.critical { background: var(--error); }

    /* Hotspots Section */
    .hotspots-section {
        margin-bottom: 24px;
    }

    .hotspots-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all 0.2s;
    }

    .hotspots-header:hover {
        border-color: var(--border-accent);
    }

    .hotspots-header.active {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom-color: transparent;
    }

    .hotspots-toggle {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .hotspots-header.active .hotspots-toggle {
        transform: rotate(180deg);
    }

    .hotspots-title {
        flex: 1;
        font-weight: 600;
        color: var(--text-primary);
    }

    .hotspots-count {
        padding: 4px 12px;
        background: var(--warning-muted);
        color: var(--warning);
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .hotspots-content {
        display: none;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-top: none;
        border-bottom-left-radius: var(--radius-lg);
        border-bottom-right-radius: var(--radius-lg);
        padding: 20px;
    }

    .hotspots-content.active {
        display: block;
    }

    .hotspot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .hotspot-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 16px;
    }

    .hotspot-card.high {
        border-color: var(--error);
        background: var(--error-muted);
    }

    .hotspot-card.medium {
        border-color: var(--warning);
        background: var(--warning-muted);
    }

    .hotspot-metric {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-tertiary);
        margin-bottom: 4px;
    }

    .hotspot-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .hotspot-domain {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Customer Table */
    .customer-table-container {
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .table-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .table-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .filter-select {
        padding: 8px 32px 8px 12px;
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 8px center;
        background-repeat: no-repeat;
        background-size: 16px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }

    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }

    .refresh-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        animation: pulse 2s infinite;
    }

    /* Sortable Table Headers */
    .sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .sortable:hover {
        color: var(--text-primary);
    }

    .sort-icon {
        display: inline-block;
        margin-left: 4px;
        opacity: 0.5;
    }

    .sortable.active .sort-icon {
        opacity: 1;
        color: var(--accent-cyan);
    }

    /* Health Score Badge */
    .health-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .health-badge.healthy {
        background: var(--success-muted);
        color: var(--success);
    }

    .health-badge.warning {
        background: var(--warning-muted);
        color: var(--warning);
    }

    .health-badge.critical {
        background: var(--error-muted);
        color: var(--error);
    }

    /* Clickable Row */
    .clickable-row {
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .clickable-row:hover td {
        background: var(--bg-hover);
    }

    /* Metric Values */
    .metric-bar {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .metric-bar-fill {
        flex: 1;
        height: 6px;
        background: var(--bg-surface);
        border-radius: 3px;
        overflow: hidden;
        max-width: 60px;
    }

    .metric-bar-value {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .metric-bar-value.warning {
        background: var(--warning);
    }

    .metric-bar-value.danger {
        background: var(--error);
    }

    /* Issues Badge */
    .issues-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .issues-badge.none {
        background: var(--bg-surface);
        color: var(--text-tertiary);
    }

    .issues-badge.has-issues {
        background: var(--warning-muted);
        color: var(--warning);
    }

    /* Pagination */
    .table-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
    }

    .pagination-btn {
        padding: 8px 14px;
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
        background: var(--bg-hover);
        border-color: var(--border-accent);
        color: var(--text-primary);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: var(--info-muted);
        color: var(--accent-blue);
        border-color: var(--accent-blue);
    }

    /* Loading State */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(8, 8, 10, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .loading-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--bg-hover);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-tertiary);
    }

    .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<!-- Overview Stats Cards -->
<div class="fleet-stats-grid" id="overview-cards">
    <div class="fleet-stat-card">
        <div class="fleet-stat-icon default">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
        </div>
        <div class="stat-label">Total Customers</div>
        <div class="stat-value" id="total-customers">--</div>
    </div>
    <div class="fleet-stat-card">
        <div class="fleet-stat-icon success">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <div class="stat-label">Active Customers</div>
        <div class="stat-value success" id="active-customers">--</div>
    </div>
    <div class="fleet-stat-card warning" id="issues-card">
        <div class="fleet-stat-icon warning">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
        </div>
        <div class="stat-label">Customers with Issues</div>
        <div class="stat-value warning" id="customers-with-issues">--</div>
    </div>
    <div class="fleet-stat-card danger" id="critical-card">
        <div class="fleet-stat-icon danger">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <div class="stat-label">Critical Issues</div>
        <div class="stat-value error" id="critical-issues">--</div>
    </div>
</div>

<!-- Health Distribution Bar -->
<div class="health-distribution" id="health-distribution">
    <div class="health-distribution-header">
        <div class="health-distribution-title">Health Score Distribution</div>
        <div class="health-distribution-legend">
            <div class="legend-item">
                <div class="legend-dot healthy"></div>
                <span>Healthy (<span id="healthy-count">0</span>)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot warning"></div>
                <span>Warning (<span id="warning-count">0</span>)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot critical"></div>
                <span>Critical (<span id="critical-count">0</span>)</span>
            </div>
        </div>
    </div>
    <div class="health-bar-container">
        <div class="health-bar-segment healthy" id="bar-healthy" style="width: 0%"></div>
        <div class="health-bar-segment warning" id="bar-warning" style="width: 0%"></div>
        <div class="health-bar-segment critical" id="bar-critical" style="width: 0%"></div>
    </div>
</div>

<!-- Hotspots Section (Collapsible) -->
<div class="hotspots-section" id="hotspots-section">
    <div class="hotspots-header" id="hotspots-toggle">
        <div class="hotspots-toggle">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="hotspots-title">Resource Hotspots</div>
        <div class="hotspots-count" id="hotspots-count">0</div>
    </div>
    <div class="hotspots-content" id="hotspots-content">
        <div class="hotspot-grid" id="hotspot-grid">
            <!-- Hotspots will be populated by JavaScript -->
            <div class="empty-state" id="no-hotspots">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p>No resource hotspots detected</p>
            </div>
        </div>
    </div>
</div>

<!-- Customer Table -->
<div class="customer-table-container" style="position: relative;">
    <div class="loading-overlay" id="table-loading">
        <div class="loading-spinner"></div>
    </div>

    <div class="table-header">
        <div class="table-title">Customer Health Overview</div>
        <div class="table-controls">
            <select class="filter-select" id="health-filter">
                <option value="all">All Status</option>
                <option value="healthy">Healthy (80+)</option>
                <option value="warning">Warning (50-79)</option>
                <option value="critical">Critical (&lt;50)</option>
            </select>
            <div class="refresh-indicator">
                <div class="refresh-dot"></div>
                <span id="last-refresh">Auto-refresh: 30s</span>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="customers-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="domain">
                        Domain <span class="sort-icon">&#9650;</span>
                    </th>
                    <th class="sortable" data-sort="platform">
                        Platform <span class="sort-icon">&#9650;</span>
                    </th>
                    <th class="sortable active" data-sort="health_score">
                        Health Score <span class="sort-icon">&#9660;</span>
                    </th>
                    <th class="sortable" data-sort="cpu_percent">
                        CPU% <span class="sort-icon">&#9650;</span>
                    </th>
                    <th class="sortable" data-sort="memory_percent">
                        Memory% <span class="sort-icon">&#9650;</span>
                    </th>
                    <th class="sortable" data-sort="open_issues_count">
                        Issues <span class="sort-icon">&#9650;</span>
                    </th>
                    <th class="sortable" data-sort="last_check">
                        Last Check <span class="sort-icon">&#9650;</span>
                    </th>
                </tr>
            </thead>
            <tbody id="customers-tbody">
                <!-- Rows populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="table-footer">
        <div class="pagination-info" id="pagination-info">
            Showing 0 of 0 customers
        </div>
        <div class="pagination-controls" id="pagination-controls">
            <!-- Pagination buttons populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce() }}">
(function() {
    'use strict';

    // State
    let currentPage = 1;
    let perPage = 20;
    let sortBy = 'health_score';
    let sortOrder = 'asc';
    let healthFilter = 'all';
    let refreshTimer = null;
    let lastRefreshTime = Date.now();

    // DOM Elements
    const tableLoading = document.getElementById('table-loading');
    const customersTbody = document.getElementById('customers-tbody');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationControls = document.getElementById('pagination-controls');
    const healthFilterSelect = document.getElementById('health-filter');
    const lastRefreshSpan = document.getElementById('last-refresh');

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Create element safely
    function createSafeElement(tag, className, textContent) {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (textContent !== undefined) el.textContent = textContent;
        return el;
    }

    // Fetch Overview Data
    async function fetchOverview() {
        try {
            const response = await fetch('/admin/api/fleet/overview');
            const data = await response.json();

            document.getElementById('total-customers').textContent = data.total_customers;
            document.getElementById('active-customers').textContent = data.active_customers;
            document.getElementById('customers-with-issues').textContent = data.customers_with_issues;
            document.getElementById('critical-issues').textContent = data.critical_issues;

            // Update card styling based on values
            const issuesCard = document.getElementById('issues-card');
            const criticalCard = document.getElementById('critical-card');

            if (data.customers_with_issues === 0) {
                issuesCard.classList.remove('warning');
            } else {
                issuesCard.classList.add('warning');
            }

            if (data.critical_issues === 0) {
                criticalCard.classList.remove('danger');
            } else {
                criticalCard.classList.add('danger');
            }
        } catch (error) {
            console.error('Error fetching overview:', error);
        }
    }

    // Fetch Health Distribution
    async function fetchHealthDistribution() {
        try {
            const response = await fetch('/admin/api/fleet/health-distribution');
            const data = await response.json();

            const total = data.healthy_count + data.warning_count + data.critical_count;

            document.getElementById('healthy-count').textContent = data.healthy_count;
            document.getElementById('warning-count').textContent = data.warning_count;
            document.getElementById('critical-count').textContent = data.critical_count;

            const barHealthy = document.getElementById('bar-healthy');
            const barWarning = document.getElementById('bar-warning');
            const barCritical = document.getElementById('bar-critical');

            if (total > 0) {
                const healthyPct = (data.healthy_count / total * 100).toFixed(1);
                const warningPct = (data.warning_count / total * 100).toFixed(1);
                const criticalPct = (data.critical_count / total * 100).toFixed(1);

                barHealthy.style.width = healthyPct + '%';
                barWarning.style.width = warningPct + '%';
                barCritical.style.width = criticalPct + '%';

                // Show percentage if segment is wide enough
                barHealthy.textContent = parseFloat(healthyPct) > 10 ? healthyPct + '%' : '';
                barWarning.textContent = parseFloat(warningPct) > 10 ? warningPct + '%' : '';
                barCritical.textContent = parseFloat(criticalPct) > 10 ? criticalPct + '%' : '';
            }
        } catch (error) {
            console.error('Error fetching health distribution:', error);
        }
    }

    // Fetch Hotspots
    async function fetchHotspots() {
        try {
            const response = await fetch('/admin/api/fleet/customers?per_page=100&sort_by=cpu_percent&sort_order=desc');
            const data = await response.json();

            const hotspots = data.customers.filter(function(c) {
                return (c.cpu_percent && c.cpu_percent > 80) ||
                       (c.memory_percent && c.memory_percent > 85);
            }).slice(0, 6);

            const hotspotGrid = document.getElementById('hotspot-grid');
            const noHotspots = document.getElementById('no-hotspots');
            const hotspotCount = document.getElementById('hotspots-count');

            hotspotCount.textContent = hotspots.length;

            // Clear existing hotspot cards (keep noHotspots element)
            Array.from(hotspotGrid.querySelectorAll('.hotspot-card')).forEach(function(card) {
                card.remove();
            });

            if (hotspots.length === 0) {
                noHotspots.style.display = 'block';
                return;
            }

            noHotspots.style.display = 'none';

            hotspots.forEach(function(h) {
                const cpuHigh = h.cpu_percent && h.cpu_percent > 90;
                const memHigh = h.memory_percent && h.memory_percent > 90;
                const severity = cpuHigh || memHigh ? 'high' : 'medium';

                var metricLabel, metricValue;
                if (h.cpu_percent && h.cpu_percent > (h.memory_percent || 0)) {
                    metricLabel = 'CPU Usage';
                    metricValue = h.cpu_percent.toFixed(1) + '%';
                } else if (h.memory_percent) {
                    metricLabel = 'Memory Usage';
                    metricValue = h.memory_percent.toFixed(1) + '%';
                } else {
                    metricLabel = 'CPU Usage';
                    metricValue = (h.cpu_percent || 0).toFixed(1) + '%';
                }

                const card = document.createElement('div');
                card.className = 'hotspot-card ' + severity;

                const metricDiv = createSafeElement('div', 'hotspot-metric', metricLabel);
                const valueDiv = createSafeElement('div', 'hotspot-value', metricValue);
                const domainDiv = createSafeElement('div', 'hotspot-domain', h.domain);

                card.appendChild(metricDiv);
                card.appendChild(valueDiv);
                card.appendChild(domainDiv);
                hotspotGrid.appendChild(card);
            });

        } catch (error) {
            console.error('Error fetching hotspots:', error);
        }
    }

    // Fetch Customers
    async function fetchCustomers() {
        tableLoading.classList.add('active');

        try {
            const params = new URLSearchParams({
                page: currentPage,
                per_page: perPage,
                sort_by: sortBy,
                sort_order: sortOrder,
                health_filter: healthFilter
            });

            const response = await fetch('/admin/api/fleet/customers?' + params.toString());
            const data = await response.json();

            renderCustomers(data.customers);
            renderPagination(data);

            lastRefreshTime = Date.now();
            updateRefreshIndicator();

        } catch (error) {
            console.error('Error fetching customers:', error);
            customersTbody.textContent = '';
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.setAttribute('colspan', '7');
            cell.className = 'text-muted';
            cell.style.textAlign = 'center';
            cell.style.padding = '40px';
            cell.textContent = 'Error loading customer data. Please try again.';
            row.appendChild(cell);
            customersTbody.appendChild(row);
        } finally {
            tableLoading.classList.remove('active');
        }
    }

    // Render Customer Rows
    function renderCustomers(customers) {
        customersTbody.textContent = '';

        if (customers.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.setAttribute('colspan', '7');
            cell.className = 'text-muted';
            cell.style.textAlign = 'center';
            cell.style.padding = '40px';
            cell.textContent = 'No customers found matching the filter criteria.';
            row.appendChild(cell);
            customersTbody.appendChild(row);
            return;
        }

        customers.forEach(function(c) {
            const healthScore = c.health_score || 0;
            var healthClass = 'critical';
            if (healthScore >= 80) healthClass = 'healthy';
            else if (healthScore >= 50) healthClass = 'warning';

            const cpuPercent = c.cpu_percent || 0;
            const memoryPercent = c.memory_percent || 0;

            var cpuBarClass = '';
            if (cpuPercent > 90) cpuBarClass = 'danger';
            else if (cpuPercent > 70) cpuBarClass = 'warning';

            var memBarClass = '';
            if (memoryPercent > 90) memBarClass = 'danger';
            else if (memoryPercent > 70) memBarClass = 'warning';

            const lastCheck = c.last_check ? formatRelativeTime(c.last_check) : 'Never';

            const issuesCount = c.open_issues_count || 0;
            const issuesClass = issuesCount > 0 ? 'has-issues' : 'none';

            const row = document.createElement('tr');
            row.className = 'clickable-row';
            row.dataset.customerId = c.id;

            // Domain cell
            const domainCell = document.createElement('td');
            const domainSpan = document.createElement('span');
            domainSpan.style.color = 'var(--text-primary)';
            domainSpan.style.fontWeight = '500';
            domainSpan.textContent = c.domain;
            domainCell.appendChild(domainSpan);
            row.appendChild(domainCell);

            // Platform cell
            const platformCell = document.createElement('td');
            const platformBadge = document.createElement('span');
            platformBadge.className = 'badge badge-info';
            platformBadge.textContent = c.platform || 'N/A';
            platformCell.appendChild(platformBadge);
            row.appendChild(platformCell);

            // Health Score cell
            const healthCell = document.createElement('td');
            const healthBadge = document.createElement('span');
            healthBadge.className = 'health-badge ' + healthClass;
            healthBadge.textContent = healthScore;
            healthCell.appendChild(healthBadge);
            row.appendChild(healthCell);

            // CPU cell
            const cpuCell = document.createElement('td');
            const cpuBar = document.createElement('div');
            cpuBar.className = 'metric-bar';

            const cpuSpan = document.createElement('span');
            cpuSpan.style.minWidth = '40px';
            cpuSpan.textContent = cpuPercent.toFixed(1) + '%';
            cpuBar.appendChild(cpuSpan);

            const cpuFillContainer = document.createElement('div');
            cpuFillContainer.className = 'metric-bar-fill';
            const cpuFill = document.createElement('div');
            cpuFill.className = 'metric-bar-value' + (cpuBarClass ? ' ' + cpuBarClass : '');
            cpuFill.style.width = Math.min(cpuPercent, 100) + '%';
            cpuFillContainer.appendChild(cpuFill);
            cpuBar.appendChild(cpuFillContainer);

            cpuCell.appendChild(cpuBar);
            row.appendChild(cpuCell);

            // Memory cell
            const memCell = document.createElement('td');
            const memBar = document.createElement('div');
            memBar.className = 'metric-bar';

            const memSpan = document.createElement('span');
            memSpan.style.minWidth = '40px';
            memSpan.textContent = memoryPercent.toFixed(1) + '%';
            memBar.appendChild(memSpan);

            const memFillContainer = document.createElement('div');
            memFillContainer.className = 'metric-bar-fill';
            const memFill = document.createElement('div');
            memFill.className = 'metric-bar-value' + (memBarClass ? ' ' + memBarClass : '');
            memFill.style.width = Math.min(memoryPercent, 100) + '%';
            memFillContainer.appendChild(memFill);
            memBar.appendChild(memFillContainer);

            memCell.appendChild(memBar);
            row.appendChild(memCell);

            // Issues cell
            const issuesCell = document.createElement('td');
            const issuesBadge = document.createElement('span');
            issuesBadge.className = 'issues-badge ' + issuesClass;
            issuesBadge.textContent = issuesCount;
            issuesCell.appendChild(issuesBadge);
            row.appendChild(issuesCell);

            // Last Check cell
            const lastCheckCell = document.createElement('td');
            lastCheckCell.className = 'mono text-muted';
            lastCheckCell.textContent = lastCheck;
            row.appendChild(lastCheckCell);

            // Add click handler
            row.addEventListener('click', function() {
                window.location.href = '/admin/customer/' + c.id;
            });

            customersTbody.appendChild(row);
        });
    }

    // Render Pagination
    function renderPagination(data) {
        const totalPages = data.total_pages || 0;
        const showing = data.customers ? data.customers.length : 0;
        const start = (data.page - 1) * perPage + 1;
        const end = start + showing - 1;

        paginationInfo.textContent = data.total > 0
            ? 'Showing ' + start + '-' + end + ' of ' + data.total + ' customers'
            : 'No customers found';

        paginationControls.textContent = '';

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.textContent = 'Previous';
        prevBtn.disabled = currentPage === 1;
        prevBtn.dataset.page = currentPage - 1;
        paginationControls.appendChild(prevBtn);

        // Page numbers
        const maxButtons = 5;
        var startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        var endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-btn';
            firstBtn.textContent = '1';
            firstBtn.dataset.page = 1;
            paginationControls.appendChild(firstBtn);

            if (startPage > 2) {
                const dots = document.createElement('span');
                dots.style.color = 'var(--text-muted)';
                dots.style.padding = '0 8px';
                dots.textContent = '...';
                paginationControls.appendChild(dots);
            }
        }

        for (var i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
            pageBtn.textContent = i;
            pageBtn.dataset.page = i;
            paginationControls.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('span');
                dots.style.color = 'var(--text-muted)';
                dots.style.padding = '0 8px';
                dots.textContent = '...';
                paginationControls.appendChild(dots);
            }

            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-btn';
            lastBtn.textContent = totalPages;
            lastBtn.dataset.page = totalPages;
            paginationControls.appendChild(lastBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.textContent = 'Next';
        nextBtn.disabled = currentPage >= totalPages;
        nextBtn.dataset.page = currentPage + 1;
        paginationControls.appendChild(nextBtn);

        // Add click handlers
        paginationControls.querySelectorAll('.pagination-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                if (!this.disabled) {
                    currentPage = parseInt(this.dataset.page);
                    fetchCustomers();
                }
            });
        });
    }

    // Format relative time
    function formatRelativeTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        if (diffSec < 60) return 'Just now';
        if (diffMin < 60) return diffMin + 'm ago';
        if (diffHour < 24) return diffHour + 'h ago';
        if (diffDay < 7) return diffDay + 'd ago';

        return date.toLocaleDateString();
    }

    // Update refresh indicator
    function updateRefreshIndicator() {
        const elapsed = Math.floor((Date.now() - lastRefreshTime) / 1000);
        const remaining = Math.max(0, 30 - elapsed);
        lastRefreshSpan.textContent = 'Refresh in: ' + remaining + 's';
    }

    // Initialize Sort Headers
    function initSortHeaders() {
        document.querySelectorAll('.sortable').forEach(function(th) {
            th.addEventListener('click', function() {
                const newSortBy = this.dataset.sort;

                if (sortBy === newSortBy) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    sortBy = newSortBy;
                    sortOrder = 'asc';
                }

                // Update header styles
                document.querySelectorAll('.sortable').forEach(function(h) {
                    h.classList.remove('active');
                    h.querySelector('.sort-icon').innerHTML = '&#9650;';
                });

                this.classList.add('active');
                this.querySelector('.sort-icon').innerHTML = sortOrder === 'asc' ? '&#9650;' : '&#9660;';

                currentPage = 1;
                fetchCustomers();
            });
        });
    }

    // Initialize Health Filter
    function initHealthFilter() {
        healthFilterSelect.addEventListener('change', function() {
            healthFilter = this.value;
            currentPage = 1;
            fetchCustomers();
        });
    }

    // Initialize Hotspots Toggle
    function initHotspotsToggle() {
        const header = document.getElementById('hotspots-toggle');
        const content = document.getElementById('hotspots-content');

        header.addEventListener('click', function() {
            header.classList.toggle('active');
            content.classList.toggle('active');
        });
    }

    // Refresh all data
    async function refreshAll() {
        await Promise.all([
            fetchOverview(),
            fetchHealthDistribution(),
            fetchHotspots(),
            fetchCustomers()
        ]);
    }

    // Auto-refresh timer
    function startAutoRefresh() {
        refreshTimer = setInterval(function() {
            refreshAll();
        }, 30000);

        // Update countdown every second
        setInterval(updateRefreshIndicator, 1000);
    }

    // Initialize
    function init() {
        initSortHeaders();
        initHealthFilter();
        initHotspotsToggle();
        refreshAll();
        startAutoRefresh();
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
