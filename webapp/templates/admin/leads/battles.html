{% extends "admin/base_admin.html" %}

{% block title %}Speed Battles{% endblock %}
{% block page_title %}Speed Battles{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Playfair+Display:wght@500;600&display=swap');

    /* Battle-specific styling */
    .battles-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .battles-header h2 {
        font-family: 'Playfair Display', Georgia, serif;
        font-size: 1.75rem;
        font-weight: 500;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, #f4f4f6 0%, #a1a1aa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
    }

    .battles-header .subtitle {
        font-family: 'Instrument Sans', sans-serif;
        font-size: 0.875rem;
        color: var(--text-tertiary);
        margin-top: 4px;
    }

    /* Stats grid */
    .battles-stats {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-bottom: 40px;
    }

    @media (max-width: 1200px) {
        .battles-stats {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .battles-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .battle-stat {
        position: relative;
        background: linear-gradient(145deg, rgba(30, 30, 36, 0.8) 0%, rgba(24, 24, 28, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        padding: 24px;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .battle-stat::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
    }

    .battle-stat:hover {
        border-color: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 20px 40px -20px rgba(0, 0, 0, 0.5);
    }

    .battle-stat .icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
    }

    .battle-stat .icon svg {
        width: 20px;
        height: 20px;
    }

    .battle-stat.total .icon { background: rgba(0, 136, 255, 0.15); color: #0088ff; }
    .battle-stat.completed .icon { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .battle-stat.email .icon { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .battle-stat.viral .icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .battle-stat.shares .icon { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }

    .battle-stat .label {
        font-family: 'Instrument Sans', sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 8px;
    }

    .battle-stat .value {
        font-family: 'Playfair Display', Georgia, serif;
        font-size: 2.25rem;
        font-weight: 500;
        line-height: 1;
        color: var(--text-primary);
    }

    .battle-stat .trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 100px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-tertiary);
    }

    /* Filters */
    .battles-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        align-items: center;
    }

    .battles-filters .filter-input {
        font-family: 'Instrument Sans', sans-serif;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        font-size: 0.875rem;
        color: var(--text-primary);
        min-width: 160px;
        transition: all 0.2s ease;
    }

    .battles-filters .filter-input:focus {
        outline: none;
        border-color: rgba(0, 136, 255, 0.4);
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 0 0 3px rgba(0, 136, 255, 0.1);
    }

    .battles-filters select.filter-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2371717a' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 12px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 40px;
    }

    .btn-filter {
        font-family: 'Instrument Sans', sans-serif;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        border: none;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-secondary);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .btn-filter:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
    }

    /* Table */
    .battles-table-wrapper {
        background: linear-gradient(145deg, rgba(24, 24, 28, 0.6) 0%, rgba(17, 17, 20, 0.8) 100%);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        overflow: hidden;
    }

    .battles-table {
        width: 100%;
        border-collapse: collapse;
    }

    .battles-table thead {
        background: rgba(0, 0, 0, 0.3);
    }

    .battles-table th {
        font-family: 'Instrument Sans', sans-serif;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        font-weight: 600;
        padding: 16px 20px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .battles-table td {
        font-family: 'Instrument Sans', sans-serif;
        padding: 16px 20px;
        font-size: 0.875rem;
        color: var(--text-secondary);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        transition: all 0.2s ease;
    }

    .battles-table tbody tr {
        transition: all 0.2s ease;
    }

    .battles-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .battles-table tbody tr:hover td {
        color: var(--text-primary);
    }

    /* Battle UID */
    .battle-uid {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        color: var(--accent-cyan);
        background: rgba(0, 212, 255, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
    }

    /* URL cells */
    .url-cell {
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    /* Score display */
    .score-vs {
        display: flex;
        align-items: center;
        gap: 8px;
        font-variant-numeric: tabular-nums;
    }

    .score-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .score-badge.winner {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
    }

    .score-badge.loser {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }

    .score-badge.tie {
        background: rgba(245, 158, 11, 0.1);
        color: #fbbf24;
    }

    .vs-text {
        color: var(--text-muted);
        font-size: 0.7rem;
        text-transform: uppercase;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .status-badge::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .status-badge.pending { background: rgba(245, 158, 11, 0.12); color: #fbbf24; }
    .status-badge.pending::before { background: #fbbf24; }
    .status-badge.scanning { background: rgba(59, 130, 246, 0.12); color: #60a5fa; }
    .status-badge.scanning::before { background: #60a5fa; animation: pulse 2s infinite; }
    .status-badge.completed { background: rgba(34, 197, 94, 0.12); color: #4ade80; }
    .status-badge.completed::before { background: #4ade80; }
    .status-badge.failed { background: rgba(239, 68, 68, 0.12); color: #f87171; }
    .status-badge.failed::before { background: #f87171; }

    /* Winner indicator */
    .winner-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .winner-badge.challenger { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .winner-badge.opponent { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .winner-badge.tie { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }

    /* Email indicator */
    .email-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .email-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .email-dot.captured { background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
    .email-dot.none { background: var(--text-muted); }

    /* Referral indicator */
    .referral-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: rgba(168, 85, 247, 0.15);
        color: #c084fc;
        border-radius: 4px;
    }

    /* View button */
    .btn-view {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-view:hover {
        background: rgba(0, 136, 255, 0.1);
        border-color: rgba(0, 136, 255, 0.3);
        color: #0088ff;
    }

    /* Pagination */
    .battles-pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 32px;
    }

    .battles-pagination a,
    .battles-pagination span {
        font-family: 'Instrument Sans', sans-serif;
        padding: 10px 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .battles-pagination a:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-primary);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .battles-pagination .active {
        background: rgba(0, 136, 255, 0.15);
        border-color: rgba(0, 136, 255, 0.3);
        color: #0088ff;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: var(--text-tertiary);
    }

    .empty-state .icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-state .icon svg {
        width: 32px;
        height: 32px;
        color: var(--text-muted);
    }

    .empty-state h3 {
        font-family: 'Playfair Display', Georgia, serif;
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .results-count {
        font-family: 'Instrument Sans', sans-serif;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 20px;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="battles-stats">
    <div class="battle-stat total">
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
        </div>
        <div class="label">Total Battles</div>
        <div class="value">{{ battle_stats.total_battles or 0 }}</div>
    </div>
    <div class="battle-stat completed">
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <div class="label">Completed</div>
        <div class="value">{{ battle_stats.completed_battles or 0 }}</div>
        {% if battle_stats.total_battles %}
        <span class="trend">{{ ((battle_stats.completed_battles or 0) / battle_stats.total_battles * 100)|round(1) }}% success rate</span>
        {% endif %}
    </div>
    <div class="battle-stat email">
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
        </div>
        <div class="label">Email Capture</div>
        <div class="value">{{ battle_stats.email_capture_rate or 0 }}%</div>
    </div>
    <div class="battle-stat viral">
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </div>
        <div class="label">From Referrals</div>
        <div class="value">{{ battle_stats.from_referrals or 0 }}</div>
        <span class="trend">K={{ battle_stats.viral_coefficient or 0 }}</span>
    </div>
    <div class="battle-stat shares">
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
        </div>
        <div class="label">Total Shares</div>
        <div class="value">{{ battle_stats.total_shares or 0 }}</div>
    </div>
</div>

<!-- Header -->
<div class="battles-header">
    <div>
        <h2>Speed Battles</h2>
        <p class="subtitle">Manage head-to-head performance comparisons</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <a href="{{ url_for('admin.leads_admin.dashboard') }}" class="btn-filter">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
            Back to Leads
        </a>
    </div>
</div>

<!-- Filters -->
<form method="GET" class="battles-filters">
    <select name="status" class="filter-input">
        <option value="">All Statuses</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="scanning" {% if status_filter == 'scanning' %}selected{% endif %}>Scanning</option>
        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
        <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
    </select>
    <select name="winner" class="filter-input">
        <option value="">All Winners</option>
        <option value="challenger" {% if winner_filter == 'challenger' %}selected{% endif %}>Challenger Won</option>
        <option value="opponent" {% if winner_filter == 'opponent' %}selected{% endif %}>Opponent Won</option>
        <option value="tie" {% if winner_filter == 'tie' %}selected{% endif %}>Tie</option>
    </select>
    <select name="has_email" class="filter-input">
        <option value="">All Emails</option>
        <option value="yes" {% if email_filter == 'yes' %}selected{% endif %}>With Email</option>
        <option value="no" {% if email_filter == 'no' %}selected{% endif %}>No Email</option>
    </select>
    <button type="submit" class="btn-filter">Filter</button>
    {% if status_filter or winner_filter or email_filter %}
    <a href="{{ url_for('admin.leads_admin.battles') }}" class="btn-filter">Clear</a>
    {% endif %}
</form>

<!-- Results count -->
<p class="results-count">Showing {{ battles|length }} of {{ total }} battles</p>

<!-- Battles Table -->
<div class="battles-table-wrapper">
    <table class="battles-table">
        <thead>
            <tr>
                <th>Battle</th>
                <th>Challenger</th>
                <th>Opponent</th>
                <th>Score</th>
                <th>Winner</th>
                <th>Email</th>
                <th>Status</th>
                <th>Created</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for battle in battles %}
            <tr>
                <td>
                    <span class="battle-uid">{{ battle.battle_uid }}</span>
                    {% if battle.referrer_battle_id %}
                    <span class="referral-badge" title="Referred from another battle">ref</span>
                    {% endif %}
                </td>
                <td class="url-cell" title="{{ battle.challenger_url }}">{{ battle.challenger_url }}</td>
                <td class="url-cell" title="{{ battle.opponent_url }}">{{ battle.opponent_url }}</td>
                <td>
                    {% if battle.challenger_score is not none and battle.opponent_score is not none %}
                    <div class="score-vs">
                        <span class="score-badge {% if battle.winner == 'challenger' %}winner{% elif battle.winner == 'opponent' %}loser{% else %}tie{% endif %}">
                            {{ battle.challenger_score }}
                        </span>
                        <span class="vs-text">vs</span>
                        <span class="score-badge {% if battle.winner == 'opponent' %}winner{% elif battle.winner == 'challenger' %}loser{% else %}tie{% endif %}">
                            {{ battle.opponent_score }}
                        </span>
                    </div>
                    {% else %}
                    <span style="color: var(--text-muted);">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if battle.winner %}
                    <span class="winner-badge {{ battle.winner }}">
                        {% if battle.winner == 'challenger' %}
                        Challenger +{{ battle.margin }}
                        {% elif battle.winner == 'opponent' %}
                        Opponent +{{ battle.margin }}
                        {% else %}
                        Tie
                        {% endif %}
                    </span>
                    {% else %}
                    <span style="color: var(--text-muted);">-</span>
                    {% endif %}
                </td>
                <td>
                    <div class="email-indicator">
                        <span class="email-dot {% if battle.email %}captured{% else %}none{% endif %}"></span>
                        {% if battle.email %}
                        <span style="font-size: 0.8rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ battle.email }}">{{ battle.email }}</span>
                        {% else %}
                        <span style="color: var(--text-muted); font-size: 0.8rem;">-</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <span class="status-badge {{ battle.status }}">{{ battle.status }}</span>
                </td>
                <td style="color: var(--text-muted); font-size: 0.8rem;">
                    {{ battle.created_at.strftime('%b %d, %H:%M') if battle.created_at else '-' }}
                </td>
                <td>
                    <a href="{{ url_for('admin.leads_admin.battle_detail', battle_id=battle.id) }}" class="btn-view">
                        View
                        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <div class="icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h3>No battles found</h3>
                        <p>Speed battles will appear here when visitors use the battle tool.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="battles-pagination">
    {% if page > 1 %}
    <a href="{{ url_for('admin.leads_admin.battles', page=page-1, status=status_filter, winner=winner_filter, has_email=email_filter) }}">Previous</a>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
    {% if p == page %}
    <span class="active">{{ p }}</span>
    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
    <a href="{{ url_for('admin.leads_admin.battles', page=p, status=status_filter, winner=winner_filter, has_email=email_filter) }}">{{ p }}</a>
    {% elif p == page - 3 or p == page + 3 %}
    <span>...</span>
    {% endif %}
    {% endfor %}

    {% if page < total_pages %}
    <a href="{{ url_for('admin.leads_admin.battles', page=page+1, status=status_filter, winner=winner_filter, has_email=email_filter) }}">Next</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
