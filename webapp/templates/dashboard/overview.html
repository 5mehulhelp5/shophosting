{% extends "dashboard/base_dashboard.html" %}

{% block page_title %}Overview{% endblock %}

{% block dashboard_css %}
/* Health Score Widget */
.health-score-widget {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}

.health-score-widget::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--gradient-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.health-score-widget:hover::before {
    opacity: 1;
}

.health-score-widget:hover {
    box-shadow: var(--shadow-glow);
}

.health-score-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.health-score-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.health-score-title svg {
    color: var(--accent-cyan);
}

.health-score-refresh {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.health-score-refresh:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.health-score-refresh.loading svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.health-score-content {
    display: flex;
    gap: 32px;
    align-items: flex-start;
}

/* Circular Gauge */
.health-gauge-container {
    flex-shrink: 0;
    text-align: center;
}

.health-gauge {
    position: relative;
    width: 140px;
    height: 140px;
}

.health-gauge canvas {
    width: 100% !important;
    height: 100% !important;
}

.health-gauge-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.health-gauge-score {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1;
    color: var(--text-primary);
}

.health-gauge-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 4px;
}

.health-trend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-top: 12px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.health-trend svg {
    width: 16px;
    height: 16px;
}

.health-trend.up {
    color: var(--success);
}

.health-trend.down {
    color: var(--error);
}

.health-trend.stable {
    color: var(--text-muted);
}

/* Factors List */
.health-factors {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.health-factor {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.health-factor:hover {
    background: var(--bg-hover);
}

.health-factor-name {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.health-factor-bar {
    flex: 0 0 100px;
    height: 6px;
    background: var(--bg-deep);
    border-radius: 3px;
    overflow: hidden;
}

.health-factor-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.health-factor-fill.green {
    background: var(--success);
}

.health-factor-fill.yellow {
    background: var(--warning);
}

.health-factor-fill.red {
    background: var(--error);
}

.health-factor-fill.gray {
    background: var(--text-muted);
}

.health-factor-score {
    min-width: 32px;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: right;
    color: var(--text-primary);
}

/* Loading State */
.health-score-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    color: var(--text-muted);
}

.health-score-loading::after {
    content: '';
    width: 24px;
    height: 24px;
    margin-left: 12px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-cyan);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

/* Error State */
.health-score-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    color: var(--text-muted);
    text-align: center;
    gap: 8px;
}

.health-score-error svg {
    width: 32px;
    height: 32px;
    color: var(--error);
}

/* Responsive */
@media (max-width: 768px) {
    .health-score-content {
        flex-direction: column;
        align-items: center;
    }

    .health-factors {
        width: 100%;
    }

    .health-factor-bar {
        flex: 0 0 80px;
    }
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 32px;
}

.quick-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-accent);
    box-shadow: var(--shadow-glow);
}

.quick-action-btn svg {
    width: 18px;
    height: 18px;
    opacity: 0.8;
}

.quick-action-btn.primary {
    background: var(--gradient-primary);
    border: none;
    color: white;
}

.quick-action-btn.primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Stat Cards Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.stat-card::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--gradient-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card:hover {
    box-shadow: var(--shadow-glow);
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg {
    width: 20px;
    height: 20px;
}

.stat-icon.status {
    background: var(--success-muted);
    color: var(--success);
}

.stat-icon.status.stopped {
    background: var(--error-muted);
    color: var(--error);
}

.stat-icon.disk {
    background: var(--warning-muted);
    color: var(--warning);
}

.stat-icon.bandwidth {
    background: var(--info-muted);
    color: var(--info);
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
}

.stat-value.running {
    color: var(--success);
}

.stat-value.stopped {
    color: var(--error);
}

.stat-subtext {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    margin-top: 4px;
}

/* Progress bar for stats */
.stat-progress {
    height: 6px;
    background: var(--bg-hover);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
}

.stat-progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.stat-progress-fill.healthy {
    background: var(--success);
}

.stat-progress-fill.warning {
    background: var(--warning);
}

.stat-progress-fill.critical {
    background: var(--error);
}

/* Store Details Card */
.details-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.details-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.details-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0;
}

.detail-item {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
    border-right: 1px solid var(--border-subtle);
}

.detail-item:nth-child(2n) {
    border-right: none;
}

.detail-item:nth-last-child(-n+2) {
    border-bottom: none;
}

.detail-label {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
}

.detail-value {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
}

.detail-value a {
    color: var(--accent-blue);
    text-decoration: none;
}

.detail-value a:hover {
    text-decoration: underline;
}

.details-actions {
    padding: 20px 28px;
    display: flex;
    gap: 12px;
    border-top: 1px solid var(--border-subtle);
}

/* Responsive */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .quick-actions {
        flex-direction: column;
    }

    .quick-action-btn {
        justify-content: center;
    }

    .details-grid {
        grid-template-columns: 1fr;
    }

    .detail-item {
        border-right: none;
    }
}
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Overview</h1>
    <p class="page-subtitle">Welcome back! Here's how your store is doing.</p>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <a href="{{ customer.store_url }}" target="_blank" class="quick-action-btn primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        Visit Store
    </a>
    <button id="restart-btn" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Restart Store
    </button>
    <a href="{{ url_for('dashboard_backups') }}" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Create Backup
    </a>
    <a href="{{ url_for('dashboard_health') }}" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        View Logs
    </a>
</div>

<!-- Health Score Widget -->
<div class="health-score-widget" id="health-score-widget">
    <div class="health-score-header">
        <h2 class="health-score-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Health Score
        </h2>
        <button class="health-score-refresh" id="health-score-refresh" title="Refresh health score">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
    </div>

    <div id="health-score-content">
        <div class="health-score-loading">Loading health score...</div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <!-- Status Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Status</span>
            <div class="stat-icon status" id="status-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
        </div>
        <div class="stat-value running" id="status-value">Running</div>
        <div class="stat-subtext" id="uptime-text">Uptime: Loading...</div>
    </div>

    <!-- Disk Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Disk</span>
            <div class="stat-icon disk">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                </svg>
            </div>
        </div>
        <div class="stat-value">{{ usage.disk.used_gb|default(0) }} GB</div>
        <div class="stat-subtext">of {{ usage.disk.limit_gb|default(10) }} GB</div>
        <div class="stat-progress">
            <div class="stat-progress-fill {% if usage.disk.percent|default(0) >= 90 %}critical{% elif usage.disk.percent|default(0) >= 80 %}warning{% else %}healthy{% endif %}"
                 style="width: {{ [usage.disk.percent|default(0), 100]|min }}%"></div>
        </div>
    </div>

    <!-- Bandwidth Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Bandwidth</span>
            <div class="stat-icon bandwidth">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
            </div>
        </div>
        <div class="stat-value">{{ usage.bandwidth.used_gb|default(0) }} GB</div>
        <div class="stat-subtext">of {{ usage.bandwidth.limit_gb|default(100) }} GB</div>
        <div class="stat-progress">
            <div class="stat-progress-fill {% if usage.bandwidth.percent|default(0) >= 90 %}critical{% elif usage.bandwidth.percent|default(0) >= 80 %}warning{% else %}healthy{% endif %}"
                 style="width: {{ [usage.bandwidth.percent|default(0), 100]|min }}%"></div>
        </div>
    </div>
</div>

<!-- Store Details -->
<div class="details-card">
    <div class="details-header">
        <h2 class="details-title">Store Details</h2>
    </div>
    <div class="details-grid">
        <div class="detail-item">
            <div class="detail-label">Domain</div>
            <div class="detail-value">
                <a href="https://{{ customer.domain }}" target="_blank">{{ customer.domain }}</a>
            </div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Platform</div>
            <div class="detail-value">{{ customer.platform|title }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Plan</div>
            <div class="detail-value">{{ plan.name if plan else 'N/A' }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Created</div>
            <div class="detail-value">{{ customer.created_at.strftime('%b %d, %Y') if customer.created_at else 'N/A' }}</div>
        </div>
    </div>
    <div class="details-actions">
        {% if credentials %}
        <a href="{{ credentials.admin_url }}" target="_blank" class="quick-action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            Admin Panel
        </a>
        {% endif %}
        <a href="https://{{ customer.domain }}:8443" target="_blank" class="quick-action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
            </svg>
            phpMyAdmin
        </a>
    </div>
</div>
{% endblock %}

{% block dashboard_js_block %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" nonce="{{ csp_nonce() }}"></script>
<script nonce="{{ csp_nonce() }}">
    let restartCooldown = false;
    let healthScoreChart = null;

    // Factor display names
    const factorNames = {
        'page_speed': 'Page Speed',
        'resource_usage': 'Resources',
        'database_health': 'Database',
        'cache_efficiency': 'Cache',
        'uptime': 'Uptime'
    };

    // Fetch and render health score
    async function fetchHealthScore() {
        const contentEl = document.getElementById('health-score-content');
        const refreshBtn = document.getElementById('health-score-refresh');

        refreshBtn.classList.add('loading');

        try {
            const response = await fetch('/api/customer/health-score', {
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to fetch health score');
            }

            const data = await response.json();
            renderHealthScore(data);
        } catch (error) {
            console.error('Failed to fetch health score:', error);
            renderHealthScoreError(contentEl);
        } finally {
            refreshBtn.classList.remove('loading');
        }
    }

    // Render error state using safe DOM methods
    function renderHealthScoreError(container) {
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        const errorDiv = document.createElement('div');
        errorDiv.className = 'health-score-error';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        svg.appendChild(circle);

        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '12');
        line1.setAttribute('y1', '8');
        line1.setAttribute('x2', '12');
        line1.setAttribute('y2', '12');
        svg.appendChild(line1);

        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '12');
        line2.setAttribute('y1', '16');
        line2.setAttribute('x2', '12.01');
        line2.setAttribute('y2', '16');
        svg.appendChild(line2);

        errorDiv.appendChild(svg);

        const span = document.createElement('span');
        span.textContent = 'Unable to load health score';
        errorDiv.appendChild(span);

        container.appendChild(errorDiv);
    }

    // Render the health score widget using safe DOM methods
    function renderHealthScore(data) {
        const contentEl = document.getElementById('health-score-content');
        const score = data.score;
        const color = data.color;
        const trend = data.trend;
        const factors = data.factors;

        // Clear existing content
        while (contentEl.firstChild) {
            contentEl.removeChild(contentEl.firstChild);
        }

        // Get CSS color value for the score
        const colorValue = getColorValue(color);

        // Create main content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'health-score-content';

        // Create gauge container
        const gaugeContainer = document.createElement('div');
        gaugeContainer.className = 'health-gauge-container';

        const gauge = document.createElement('div');
        gauge.className = 'health-gauge';

        const canvas = document.createElement('canvas');
        canvas.id = 'health-gauge-canvas';
        gauge.appendChild(canvas);

        const gaugeCenter = document.createElement('div');
        gaugeCenter.className = 'health-gauge-center';

        const scoreEl = document.createElement('div');
        scoreEl.className = 'health-gauge-score';
        scoreEl.style.color = colorValue;
        scoreEl.textContent = score;
        gaugeCenter.appendChild(scoreEl);

        const labelEl = document.createElement('div');
        labelEl.className = 'health-gauge-label';
        labelEl.textContent = 'out of 100';
        gaugeCenter.appendChild(labelEl);

        gauge.appendChild(gaugeCenter);
        gaugeContainer.appendChild(gauge);

        // Create trend indicator
        const trendDiv = document.createElement('div');
        trendDiv.className = 'health-trend ' + trend;

        const trendSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        trendSvg.setAttribute('viewBox', '0 0 24 24');
        trendSvg.setAttribute('fill', 'none');
        trendSvg.setAttribute('stroke', 'currentColor');
        trendSvg.setAttribute('stroke-width', '2');

        const trendPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        if (trend === 'up') {
            trendPath.setAttribute('d', 'M12 19V5M5 12l7-7 7 7');
        } else if (trend === 'down') {
            trendPath.setAttribute('d', 'M12 5v14M19 12l-7 7-7-7');
        } else {
            trendPath.setAttribute('d', 'M5 12h14');
        }
        trendSvg.appendChild(trendPath);
        trendDiv.appendChild(trendSvg);

        const trendText = document.createElement('span');
        if (trend === 'up') {
            trendText.textContent = '+' + data.score_change + ' vs 24h ago';
        } else if (trend === 'down') {
            trendText.textContent = data.score_change + ' vs 24h ago';
        } else {
            trendText.textContent = 'Stable';
        }
        trendDiv.appendChild(trendText);
        gaugeContainer.appendChild(trendDiv);

        contentDiv.appendChild(gaugeContainer);

        // Create factors list
        const factorsDiv = document.createElement('div');
        factorsDiv.className = 'health-factors';

        for (const [key, factor] of Object.entries(factors)) {
            const factorEl = document.createElement('div');
            factorEl.className = 'health-factor';
            factorEl.setAttribute('data-factor', key);
            factorEl.title = 'Click for details (coming soon)';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'health-factor-name';
            nameSpan.textContent = factorNames[key] || key;
            factorEl.appendChild(nameSpan);

            const barDiv = document.createElement('div');
            barDiv.className = 'health-factor-bar';

            const fillDiv = document.createElement('div');
            fillDiv.className = 'health-factor-fill ' + (factor.color || 'gray');
            fillDiv.style.width = (factor.data_available ? factor.score : 0) + '%';
            barDiv.appendChild(fillDiv);
            factorEl.appendChild(barDiv);

            const scoreSpan = document.createElement('span');
            scoreSpan.className = 'health-factor-score';
            scoreSpan.textContent = factor.data_available ? factor.score : '--';
            factorEl.appendChild(scoreSpan);

            factorsDiv.appendChild(factorEl);
        }

        contentDiv.appendChild(factorsDiv);
        contentEl.appendChild(contentDiv);

        // Create the doughnut chart
        createHealthGauge(score, color);
    }

    // Get CSS variable color value
    function getColorValue(color) {
        const colorMap = {
            'green': '#22c55e',
            'yellow': '#eab308',
            'red': '#ef4444',
            'gray': '#6b7280'
        };
        return colorMap[color] || colorMap['gray'];
    }

    // Create Chart.js doughnut gauge
    function createHealthGauge(score, color) {
        const canvas = document.getElementById('health-gauge-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const colorValue = getColorValue(color);

        // Destroy previous chart if exists
        if (healthScoreChart) {
            healthScoreChart.destroy();
        }

        healthScoreChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [colorValue, 'rgba(255, 255, 255, 0.05)'],
                    borderWidth: 0,
                    cutout: '78%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                rotation: -90,
                circumference: 360,
                animation: {
                    animateRotate: true,
                    duration: 1000
                }
            }
        });
    }

    // Fetch container status
    async function fetchContainerStatus() {
        try {
            const response = await fetch('/api/container/status', {
                credentials: 'same-origin'
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Non-JSON response');
            }

            const data = await response.json();

            const statusValue = document.getElementById('status-value');
            const statusIcon = document.getElementById('status-icon');
            const uptimeText = document.getElementById('uptime-text');

            if (data.running) {
                statusValue.textContent = 'Running';
                statusValue.className = 'stat-value running';
                statusIcon.className = 'stat-icon status';
                uptimeText.textContent = data.uptime ? 'Uptime: ' + data.uptime : '';
            } else {
                statusValue.textContent = data.status === 'restarting' ? 'Restarting' : 'Stopped';
                statusValue.className = 'stat-value stopped';
                statusIcon.className = 'stat-icon status stopped';
                uptimeText.textContent = '';
            }

        } catch (error) {
            console.error('Failed to fetch status:', error);
        }
    }

    // Restart container
    async function restartContainer() {
        if (restartCooldown) {
            alert('Please wait 5 minutes between restarts.');
            return;
        }

        if (!confirm('Are you sure you want to restart your store? It will be unavailable for ~30 seconds.')) {
            return;
        }

        const btn = document.getElementById('restart-btn');
        btn.disabled = true;
        btn.style.opacity = '0.5';

        try {
            const response = await fetch('/api/container/restart', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                restartCooldown = true;
                setTimeout(() => {
                    restartCooldown = false;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 300000);

                setTimeout(fetchContainerStatus, 5000);
                setTimeout(fetchContainerStatus, 15000);
                setTimeout(fetchContainerStatus, 30000);
            } else {
                alert('Restart failed: ' + data.message);
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        } catch (error) {
            alert('Failed to restart: ' + error.message);
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }

    // Initialize
    document.getElementById('restart-btn').addEventListener('click', restartContainer);
    document.getElementById('health-score-refresh').addEventListener('click', fetchHealthScore);

    // Fetch initial data
    fetchContainerStatus();
    fetchHealthScore();

    // Refresh intervals
    setInterval(fetchContainerStatus, 10000);
    setInterval(fetchHealthScore, 60000);  // Refresh health score every minute
</script>
{% endblock %}
