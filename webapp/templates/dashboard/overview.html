{% extends "dashboard/base_dashboard.html" %}

{% block page_title %}Overview{% endblock %}

{% block dashboard_css %}
/* Health Score Widget */
.health-score-widget {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}

.health-score-widget::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--gradient-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.health-score-widget:hover::before {
    opacity: 1;
}

.health-score-widget:hover {
    box-shadow: var(--shadow-glow);
}

.health-score-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.health-score-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.health-score-title svg {
    color: var(--accent-cyan);
}

.health-score-refresh {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.health-score-refresh:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.health-score-refresh.loading svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.health-score-content {
    display: flex;
    gap: 32px;
    align-items: flex-start;
}

/* Circular Gauge */
.health-gauge-container {
    flex-shrink: 0;
    text-align: center;
}

.health-gauge {
    position: relative;
    width: 140px;
    height: 140px;
}

.health-gauge canvas {
    width: 100% !important;
    height: 100% !important;
}

.health-gauge-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.health-gauge-score {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1;
    color: var(--text-primary);
}

.health-gauge-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 4px;
}

.health-trend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-top: 12px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.health-trend svg {
    width: 16px;
    height: 16px;
}

.health-trend.up {
    color: var(--success);
}

.health-trend.down {
    color: var(--error);
}

.health-trend.stable {
    color: var(--text-muted);
}

/* Factors List */
.health-factors {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.health-factor {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.health-factor:hover {
    background: var(--bg-hover);
}

.health-factor-name {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.health-factor-bar {
    flex: 0 0 100px;
    height: 6px;
    background: var(--bg-deep);
    border-radius: 3px;
    overflow: hidden;
}

.health-factor-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.health-factor-fill.green {
    background: var(--success);
}

.health-factor-fill.yellow {
    background: var(--warning);
}

.health-factor-fill.red {
    background: var(--error);
}

.health-factor-fill.gray {
    background: var(--text-muted);
}

.health-factor-score {
    min-width: 32px;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: right;
    color: var(--text-primary);
}

/* Loading State */
.health-score-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    color: var(--text-muted);
}

.health-score-loading::after {
    content: '';
    width: 24px;
    height: 24px;
    margin-left: 12px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-cyan);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

/* Error State */
.health-score-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    color: var(--text-muted);
    text-align: center;
    gap: 8px;
}

.health-score-error svg {
    width: 32px;
    height: 32px;
    color: var(--error);
}

/* Responsive */
@media (max-width: 768px) {
    .health-score-content {
        flex-direction: column;
        align-items: center;
    }

    .health-factors {
        width: 100%;
    }

    .health-factor-bar {
        flex: 0 0 80px;
    }
}

/* Performance Insights Widget */
.insights-widget {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}

.insights-widget::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--gradient-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.insights-widget:hover::before {
    opacity: 1;
}

.insights-widget:hover {
    box-shadow: var(--shadow-glow);
}

.insights-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.insights-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.insights-title svg {
    color: var(--accent-purple);
}

.insights-refresh {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.insights-refresh:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.insights-refresh.loading svg {
    animation: spin 1s linear infinite;
}

.insights-feed {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.insight-card {
    display: flex;
    gap: 12px;
    padding: 14px 16px;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

.insight-card:hover {
    background: var(--bg-hover);
}

.insight-card.warning {
    border-left-color: var(--warning);
}

.insight-card.recommendation {
    border-left-color: var(--info);
}

.insight-card.success {
    border-left-color: var(--success);
}

.insight-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.insight-icon svg {
    width: 18px;
    height: 18px;
}

.insight-icon.warning {
    background: var(--warning-muted);
    color: var(--warning);
}

.insight-icon.recommendation {
    background: var(--info-muted);
    color: var(--info);
}

.insight-icon.success {
    background: var(--success-muted);
    color: var(--success);
}

.insight-content {
    flex: 1;
    min-width: 0;
}

.insight-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.insight-message {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

.insight-time {
    flex-shrink: 0;
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
}

/* Insights Loading & Empty States */
.insights-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    color: var(--text-muted);
}

.insights-loading::after {
    content: '';
    width: 20px;
    height: 20px;
    margin-left: 10px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-purple);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.insights-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    color: var(--text-muted);
    text-align: center;
    gap: 8px;
}

.insights-empty svg {
    width: 28px;
    height: 28px;
    opacity: 0.5;
}

.insights-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    color: var(--text-muted);
    text-align: center;
    gap: 8px;
}

.insights-error svg {
    width: 28px;
    height: 28px;
    color: var(--error);
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 32px;
}

.quick-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-accent);
    box-shadow: var(--shadow-glow);
}

.quick-action-btn svg {
    width: 18px;
    height: 18px;
    opacity: 0.8;
}

.quick-action-btn.primary {
    background: var(--gradient-primary);
    border: none;
    color: white;
}

.quick-action-btn.primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Stat Cards Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.stat-card::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--gradient-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card:hover {
    box-shadow: var(--shadow-glow);
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg {
    width: 20px;
    height: 20px;
}

.stat-icon.status {
    background: var(--success-muted);
    color: var(--success);
}

.stat-icon.status.stopped {
    background: var(--error-muted);
    color: var(--error);
}

.stat-icon.disk {
    background: var(--warning-muted);
    color: var(--warning);
}

.stat-icon.bandwidth {
    background: var(--info-muted);
    color: var(--info);
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
}

.stat-value.running {
    color: var(--success);
}

.stat-value.stopped {
    color: var(--error);
}

.stat-subtext {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    margin-top: 4px;
}

/* Progress bar for stats */
.stat-progress {
    height: 6px;
    background: var(--bg-hover);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
}

.stat-progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.stat-progress-fill.healthy {
    background: var(--success);
}

.stat-progress-fill.warning {
    background: var(--warning);
}

.stat-progress-fill.critical {
    background: var(--error);
}

/* ================================================
   ADMIN CREDENTIALS VAULT
   A secure-feeling credential reveal component
   ================================================ */
.credentials-vault {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: var(--radius-lg);
    padding: 0;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
    box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

.credentials-vault::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg,
        transparent 0%,
        rgba(99, 102, 241, 0.5) 20%,
        rgba(168, 85, 247, 0.5) 50%,
        rgba(99, 102, 241, 0.5) 80%,
        transparent 100%);
}

.vault-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.vault-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.01em;
}

.vault-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
    border: 1px solid rgba(99, 102, 241, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #a78bfa;
    transition: all 0.3s ease;
}

.vault-icon svg {
    width: 20px;
    height: 20px;
    transition: transform 0.3s ease;
}

.credentials-vault.unlocked .vault-icon {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(16, 185, 129, 0.2) 100%);
    border-color: rgba(34, 197, 94, 0.4);
    color: #4ade80;
}

.credentials-vault.unlocked .vault-icon svg {
    transform: rotate(-12deg);
}

.vault-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: rgba(99, 102, 241, 0.1);
    color: #a5b4fc;
    border: 1px solid rgba(99, 102, 241, 0.2);
}

.vault-badge svg {
    width: 12px;
    height: 12px;
}

.credentials-vault.unlocked .vault-badge {
    background: rgba(34, 197, 94, 0.1);
    color: #86efac;
    border-color: rgba(34, 197, 94, 0.2);
}

/* Vault Content - Locked State */
.vault-locked {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
    text-align: center;
}

.vault-locked-message {
    color: var(--text-tertiary);
    font-size: 0.9rem;
    margin-bottom: 20px;
    max-width: 280px;
    line-height: 1.5;
}

.vault-unlock-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
        0 4px 16px rgba(99, 102, 241, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.vault-unlock-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.vault-unlock-btn:hover {
    transform: translateY(-2px);
    box-shadow:
        0 8px 24px rgba(99, 102, 241, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.vault-unlock-btn:hover::before {
    opacity: 1;
}

.vault-unlock-btn:active {
    transform: translateY(0);
}

.vault-unlock-btn svg {
    width: 18px;
    height: 18px;
}

/* Vault Content - Unlocked State */
.vault-unlocked {
    display: none;
    padding: 24px;
}

.credentials-vault.unlocked .vault-locked {
    display: none;
}

.credentials-vault.unlocked .vault-unlocked {
    display: block;
    animation: vaultReveal 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes vaultReveal {
    0% {
        opacity: 0;
        transform: translateY(10px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

.credential-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    margin-bottom: 12px;
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.2s ease;
}

.credential-row:last-child {
    margin-bottom: 0;
}

.credential-row:hover {
    background: rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.08);
}

.credential-label {
    flex: 0 0 100px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.credential-value {
    flex: 1;
    font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
    font-size: 0.95rem;
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.03);
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    word-break: break-all;
}

.credential-value a {
    color: #93c5fd;
    text-decoration: none;
    transition: color 0.2s ease;
}

.credential-value a:hover {
    color: #bfdbfe;
    text-decoration: underline;
}

.credential-copy {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
}

.credential-copy:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: rgba(99, 102, 241, 0.4);
    color: #a5b4fc;
}

.credential-copy.copied {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.4);
    color: #4ade80;
}

.credential-copy svg {
    width: 18px;
    height: 18px;
}

/* Vault Footer */
.vault-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: rgba(0, 0, 0, 0.15);
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.vault-timer {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.vault-timer svg {
    width: 14px;
    height: 14px;
}

.vault-timer-bar {
    width: 80px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
}

.vault-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 2px;
    transition: width 1s linear;
}

.vault-lock-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.vault-lock-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: #fca5a5;
}

.vault-lock-btn svg {
    width: 14px;
    height: 14px;
}

/* Responsive */
@media (max-width: 640px) {
    .vault-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .credential-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }

    .credential-label {
        flex: none;
    }

    .credential-value {
        font-size: 0.85rem;
    }

    .vault-footer {
        flex-direction: column;
        gap: 12px;
    }
}

/* Store Details Card */
.details-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.details-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.details-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0;
}

.detail-item {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
    border-right: 1px solid var(--border-subtle);
}

.detail-item:nth-child(2n) {
    border-right: none;
}

.detail-item:nth-last-child(-n+2) {
    border-bottom: none;
}

.detail-label {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
}

.detail-value {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
}

.detail-value a {
    color: var(--accent-blue);
    text-decoration: none;
}

.detail-value a:hover {
    text-decoration: underline;
}

.details-actions {
    padding: 20px 28px;
    display: flex;
    gap: 12px;
    border-top: 1px solid var(--border-subtle);
}

/* Responsive */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .quick-actions {
        flex-direction: column;
    }

    .quick-action-btn {
        justify-content: center;
    }

    .details-grid {
        grid-template-columns: 1fr;
    }

    .detail-item {
        border-right: none;
    }
}
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Overview</h1>
    <p class="page-subtitle">Welcome back! Here's how your store is doing.</p>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <a href="{{ customer.store_url }}" target="_blank" class="quick-action-btn primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        Visit Store
    </a>
    <button id="restart-btn" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Restart Store
    </button>
    <a href="{{ url_for('dashboard_backups') }}" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Create Backup
    </a>
    <a href="{{ url_for('dashboard_health') }}" class="quick-action-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        View Logs
    </a>
</div>

<!-- Health Score Widget -->
<div class="health-score-widget" id="health-score-widget">
    <div class="health-score-header">
        <h2 class="health-score-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Health Score
        </h2>
        <button class="health-score-refresh" id="health-score-refresh" title="Refresh health score">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
    </div>

    <div id="health-score-content">
        <div class="health-score-loading">Loading health score...</div>
    </div>
</div>

<!-- Performance Insights Widget -->
<div class="insights-widget" id="insights-widget">
    <div class="insights-header">
        <h2 class="insights-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Performance Insights
        </h2>
        <button class="insights-refresh" id="insights-refresh" title="Refresh insights">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
    </div>

    <div id="insights-content">
        <div class="insights-loading">Loading insights...</div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <!-- Status Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Status</span>
            <div class="stat-icon status" id="status-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
        </div>
        <div class="stat-value running" id="status-value">Running</div>
        <div class="stat-subtext" id="uptime-text">Uptime: Loading...</div>
    </div>

    <!-- Disk Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Disk</span>
            <div class="stat-icon disk">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                </svg>
            </div>
        </div>
        <div class="stat-value">{{ usage.disk.used_gb|default(0) }} GB</div>
        <div class="stat-subtext">of {{ usage.disk.limit_gb|default(10) }} GB</div>
        <div class="stat-progress">
            <div class="stat-progress-fill {% if usage.disk.percent|default(0) >= 90 %}critical{% elif usage.disk.percent|default(0) >= 80 %}warning{% else %}healthy{% endif %}"
                 style="width: {{ [usage.disk.percent|default(0), 100]|min }}%"></div>
        </div>
    </div>

    <!-- Bandwidth Card -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Bandwidth</span>
            <div class="stat-icon bandwidth">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
            </div>
        </div>
        <div class="stat-value">{{ usage.bandwidth.used_gb|default(0) }} GB</div>
        <div class="stat-subtext">of {{ usage.bandwidth.limit_gb|default(100) }} GB</div>
        <div class="stat-progress">
            <div class="stat-progress-fill {% if usage.bandwidth.percent|default(0) >= 90 %}critical{% elif usage.bandwidth.percent|default(0) >= 80 %}warning{% else %}healthy{% endif %}"
                 style="width: {{ [usage.bandwidth.percent|default(0), 100]|min }}%"></div>
        </div>
    </div>
</div>

<!-- Admin Credentials Vault -->
{% if credentials and credentials.admin_user %}
<div class="credentials-vault" id="credentials-vault">
    <div class="vault-header">
        <div class="vault-title">
            <div class="vault-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </div>
            <span>{{ 'WordPress' if customer.platform == 'woocommerce' else 'Magento' }} Admin Credentials</span>
        </div>
        <div class="vault-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            <span class="vault-status-text">Secured</span>
        </div>
    </div>

    <!-- Locked State -->
    <div class="vault-locked">
        <p class="vault-locked-message">Your admin credentials are securely stored. Click below to reveal them temporarily.</p>
        <button class="vault-unlock-btn" id="vault-unlock-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
            </svg>
            Reveal Credentials
        </button>
    </div>

    <!-- Unlocked State -->
    <div class="vault-unlocked">
        <div class="credential-row">
            <span class="credential-label">Admin URL</span>
            <div class="credential-value">
                <a href="{{ credentials.admin_url }}" target="_blank" rel="noopener">{{ credentials.admin_url }}</a>
            </div>
            <button class="credential-copy" data-copy="{{ credentials.admin_url }}" title="Copy to clipboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </div>
        <div class="credential-row">
            <span class="credential-label">Username</span>
            <div class="credential-value" id="admin-username">{{ credentials.admin_user }}</div>
            <button class="credential-copy" data-copy="{{ credentials.admin_user }}" title="Copy to clipboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </div>
        <div class="credential-row">
            <span class="credential-label">Password</span>
            <div class="credential-value" id="admin-password">{{ credentials.admin_password }}</div>
            <button class="credential-copy" data-copy="{{ credentials.admin_password }}" title="Copy to clipboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Footer with timer -->
    <div class="vault-footer" style="display: none;">
        <div class="vault-timer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Auto-lock in <span id="vault-countdown">60</span>s</span>
            <div class="vault-timer-bar">
                <div class="vault-timer-fill" id="vault-timer-fill" style="width: 100%"></div>
            </div>
        </div>
        <button class="vault-lock-btn" id="vault-lock-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Lock Now
        </button>
    </div>
</div>
{% endif %}

<!-- Store Details -->
<div class="details-card">
    <div class="details-header">
        <h2 class="details-title">Store Details</h2>
    </div>
    <div class="details-grid">
        <div class="detail-item">
            <div class="detail-label">Domain</div>
            <div class="detail-value">
                <a href="https://{{ customer.domain }}" target="_blank">{{ customer.domain }}</a>
            </div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Platform</div>
            <div class="detail-value">{{ customer.platform|title }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Plan</div>
            <div class="detail-value">{{ plan.name if plan else 'N/A' }}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Created</div>
            <div class="detail-value">{{ customer.created_at.strftime('%b %d, %Y') if customer.created_at else 'N/A' }}</div>
        </div>
    </div>
    <div class="details-actions">
        {% if credentials %}
        <a href="{{ credentials.admin_url }}" target="_blank" class="quick-action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            Admin Panel
        </a>
        {% endif %}
        <a href="https://{{ customer.domain }}:8443" target="_blank" class="quick-action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
            </svg>
            phpMyAdmin
        </a>
    </div>
</div>
{% endblock %}

{% block dashboard_js_block %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" nonce="{{ csp_nonce() }}"></script>
<script nonce="{{ csp_nonce() }}">
    let restartCooldown = false;
    let healthScoreChart = null;

    // Factor display names
    const factorNames = {
        'page_speed': 'Page Speed',
        'resource_usage': 'Resources',
        'database_health': 'Database',
        'cache_efficiency': 'Cache',
        'uptime': 'Uptime'
    };

    // Fetch and render health score
    async function fetchHealthScore() {
        const contentEl = document.getElementById('health-score-content');
        const refreshBtn = document.getElementById('health-score-refresh');

        refreshBtn.classList.add('loading');

        try {
            const response = await fetch('/api/customer/health-score', {
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to fetch health score');
            }

            const data = await response.json();
            renderHealthScore(data);
        } catch (error) {
            console.error('Failed to fetch health score:', error);
            renderHealthScoreError(contentEl);
        } finally {
            refreshBtn.classList.remove('loading');
        }
    }

    // Render error state using safe DOM methods
    function renderHealthScoreError(container) {
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        const errorDiv = document.createElement('div');
        errorDiv.className = 'health-score-error';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        svg.appendChild(circle);

        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '12');
        line1.setAttribute('y1', '8');
        line1.setAttribute('x2', '12');
        line1.setAttribute('y2', '12');
        svg.appendChild(line1);

        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '12');
        line2.setAttribute('y1', '16');
        line2.setAttribute('x2', '12.01');
        line2.setAttribute('y2', '16');
        svg.appendChild(line2);

        errorDiv.appendChild(svg);

        const span = document.createElement('span');
        span.textContent = 'Unable to load health score';
        errorDiv.appendChild(span);

        container.appendChild(errorDiv);
    }

    // Render the health score widget using safe DOM methods
    function renderHealthScore(data) {
        const contentEl = document.getElementById('health-score-content');
        const score = data.score;
        const color = data.color;
        const trend = data.trend;
        const factors = data.factors;

        // Clear existing content
        while (contentEl.firstChild) {
            contentEl.removeChild(contentEl.firstChild);
        }

        // Get CSS color value for the score
        const colorValue = getColorValue(color);

        // Create main content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'health-score-content';

        // Create gauge container
        const gaugeContainer = document.createElement('div');
        gaugeContainer.className = 'health-gauge-container';

        const gauge = document.createElement('div');
        gauge.className = 'health-gauge';

        const canvas = document.createElement('canvas');
        canvas.id = 'health-gauge-canvas';
        gauge.appendChild(canvas);

        const gaugeCenter = document.createElement('div');
        gaugeCenter.className = 'health-gauge-center';

        const scoreEl = document.createElement('div');
        scoreEl.className = 'health-gauge-score';
        scoreEl.style.color = colorValue;
        scoreEl.textContent = score;
        gaugeCenter.appendChild(scoreEl);

        const labelEl = document.createElement('div');
        labelEl.className = 'health-gauge-label';
        labelEl.textContent = 'out of 100';
        gaugeCenter.appendChild(labelEl);

        gauge.appendChild(gaugeCenter);
        gaugeContainer.appendChild(gauge);

        // Create trend indicator
        const trendDiv = document.createElement('div');
        trendDiv.className = 'health-trend ' + trend;

        const trendSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        trendSvg.setAttribute('viewBox', '0 0 24 24');
        trendSvg.setAttribute('fill', 'none');
        trendSvg.setAttribute('stroke', 'currentColor');
        trendSvg.setAttribute('stroke-width', '2');

        const trendPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        if (trend === 'up') {
            trendPath.setAttribute('d', 'M12 19V5M5 12l7-7 7 7');
        } else if (trend === 'down') {
            trendPath.setAttribute('d', 'M12 5v14M19 12l-7 7-7-7');
        } else {
            trendPath.setAttribute('d', 'M5 12h14');
        }
        trendSvg.appendChild(trendPath);
        trendDiv.appendChild(trendSvg);

        const trendText = document.createElement('span');
        if (trend === 'up') {
            trendText.textContent = '+' + data.score_change + ' vs 24h ago';
        } else if (trend === 'down') {
            trendText.textContent = data.score_change + ' vs 24h ago';
        } else {
            trendText.textContent = 'Stable';
        }
        trendDiv.appendChild(trendText);
        gaugeContainer.appendChild(trendDiv);

        contentDiv.appendChild(gaugeContainer);

        // Create factors list
        const factorsDiv = document.createElement('div');
        factorsDiv.className = 'health-factors';

        for (const [key, factor] of Object.entries(factors)) {
            const factorEl = document.createElement('div');
            factorEl.className = 'health-factor';
            factorEl.setAttribute('data-factor', key);
            factorEl.title = 'Click for details (coming soon)';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'health-factor-name';
            nameSpan.textContent = factorNames[key] || key;
            factorEl.appendChild(nameSpan);

            const barDiv = document.createElement('div');
            barDiv.className = 'health-factor-bar';

            const fillDiv = document.createElement('div');
            fillDiv.className = 'health-factor-fill ' + (factor.color || 'gray');
            fillDiv.style.width = (factor.data_available ? factor.score : 0) + '%';
            barDiv.appendChild(fillDiv);
            factorEl.appendChild(barDiv);

            const scoreSpan = document.createElement('span');
            scoreSpan.className = 'health-factor-score';
            scoreSpan.textContent = factor.data_available ? factor.score : '--';
            factorEl.appendChild(scoreSpan);

            factorsDiv.appendChild(factorEl);
        }

        contentDiv.appendChild(factorsDiv);
        contentEl.appendChild(contentDiv);

        // Create the doughnut chart
        createHealthGauge(score, color);
    }

    // Get CSS variable color value
    function getColorValue(color) {
        const colorMap = {
            'green': '#22c55e',
            'yellow': '#eab308',
            'red': '#ef4444',
            'gray': '#6b7280'
        };
        return colorMap[color] || colorMap['gray'];
    }

    // Create Chart.js doughnut gauge
    function createHealthGauge(score, color) {
        const canvas = document.getElementById('health-gauge-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const colorValue = getColorValue(color);

        // Destroy previous chart if exists
        if (healthScoreChart) {
            healthScoreChart.destroy();
        }

        healthScoreChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [colorValue, 'rgba(255, 255, 255, 0.05)'],
                    borderWidth: 0,
                    cutout: '78%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                rotation: -90,
                circumference: 360,
                animation: {
                    animateRotate: true,
                    duration: 1000
                }
            }
        });
    }

    // Fetch container status
    async function fetchContainerStatus() {
        try {
            const response = await fetch('/api/container/status', {
                credentials: 'same-origin'
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Non-JSON response');
            }

            const data = await response.json();

            const statusValue = document.getElementById('status-value');
            const statusIcon = document.getElementById('status-icon');
            const uptimeText = document.getElementById('uptime-text');

            if (data.running) {
                statusValue.textContent = 'Running';
                statusValue.className = 'stat-value running';
                statusIcon.className = 'stat-icon status';
                uptimeText.textContent = data.uptime ? 'Uptime: ' + data.uptime : '';
            } else {
                statusValue.textContent = data.status === 'restarting' ? 'Restarting' : 'Stopped';
                statusValue.className = 'stat-value stopped';
                statusIcon.className = 'stat-icon status stopped';
                uptimeText.textContent = '';
            }

        } catch (error) {
            console.error('Failed to fetch status:', error);
        }
    }

    // Restart container
    async function restartContainer() {
        if (restartCooldown) {
            alert('Please wait 5 minutes between restarts.');
            return;
        }

        if (!confirm('Are you sure you want to restart your store? It will be unavailable for ~30 seconds.')) {
            return;
        }

        const btn = document.getElementById('restart-btn');
        btn.disabled = true;
        btn.style.opacity = '0.5';

        try {
            const response = await fetch('/api/container/restart', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                restartCooldown = true;
                setTimeout(() => {
                    restartCooldown = false;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 300000);

                setTimeout(fetchContainerStatus, 5000);
                setTimeout(fetchContainerStatus, 15000);
                setTimeout(fetchContainerStatus, 30000);
            } else {
                alert('Restart failed: ' + data.message);
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        } catch (error) {
            alert('Failed to restart: ' + error.message);
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }

    // =========================================================================
    // Performance Insights Widget
    // =========================================================================

    // Icon SVG paths for insight types
    const insightIcons = {
        warning: {
            viewBox: '0 0 24 24',
            paths: [
                {type: 'path', d: 'M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z'},
                {type: 'line', x1: '12', y1: '9', x2: '12', y2: '13'},
                {type: 'line', x1: '12', y1: '17', x2: '12.01', y2: '17'}
            ]
        },
        recommendation: {
            viewBox: '0 0 24 24',
            paths: [
                {type: 'path', d: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z'}
            ]
        },
        success: {
            viewBox: '0 0 24 24',
            paths: [
                {type: 'path', d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14'},
                {type: 'polyline', points: '22 4 12 14.01 9 11.01'}
            ]
        }
    };

    // Fetch and render insights
    async function fetchInsights() {
        const contentEl = document.getElementById('insights-content');
        const refreshBtn = document.getElementById('insights-refresh');

        refreshBtn.classList.add('loading');

        try {
            const response = await fetch('/api/customer/insights?limit=10', {
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to fetch insights');
            }

            const data = await response.json();
            renderInsights(data.insights);
        } catch (error) {
            console.error('Failed to fetch insights:', error);
            renderInsightsError(contentEl);
        } finally {
            refreshBtn.classList.remove('loading');
        }
    }

    // Render insights feed using safe DOM methods
    function renderInsights(insights) {
        const contentEl = document.getElementById('insights-content');

        // Clear existing content
        while (contentEl.firstChild) {
            contentEl.removeChild(contentEl.firstChild);
        }

        // Handle empty state
        if (!insights || insights.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'insights-empty';

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M22 11.08V12a10 10 0 1 1-5.93-9.14');
            svg.appendChild(path);

            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', '22 4 12 14.01 9 11.01');
            svg.appendChild(polyline);

            emptyDiv.appendChild(svg);

            const span = document.createElement('span');
            span.textContent = 'No issues or recommendations. Your store is running smoothly!';
            emptyDiv.appendChild(span);

            contentEl.appendChild(emptyDiv);
            return;
        }

        // Create feed container
        const feedDiv = document.createElement('div');
        feedDiv.className = 'insights-feed';

        for (const insight of insights) {
            const card = createInsightCard(insight);
            feedDiv.appendChild(card);
        }

        contentEl.appendChild(feedDiv);
    }

    // Create a single insight card using safe DOM methods
    function createInsightCard(insight) {
        const card = document.createElement('div');
        card.className = 'insight-card ' + insight.type;
        card.setAttribute('data-insight-id', insight.id);

        // Icon
        const iconDiv = document.createElement('div');
        iconDiv.className = 'insight-icon ' + insight.type;

        const iconData = insightIcons[insight.type] || insightIcons.recommendation;
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', iconData.viewBox);
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');
        svg.setAttribute('stroke-linecap', 'round');
        svg.setAttribute('stroke-linejoin', 'round');

        for (const pathData of iconData.paths) {
            let element;
            if (pathData.type === 'path') {
                element = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                element.setAttribute('d', pathData.d);
            } else if (pathData.type === 'line') {
                element = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                element.setAttribute('x1', pathData.x1);
                element.setAttribute('y1', pathData.y1);
                element.setAttribute('x2', pathData.x2);
                element.setAttribute('y2', pathData.y2);
            } else if (pathData.type === 'polyline') {
                element = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                element.setAttribute('points', pathData.points);
            }
            if (element) svg.appendChild(element);
        }

        iconDiv.appendChild(svg);
        card.appendChild(iconDiv);

        // Content
        const contentDiv = document.createElement('div');
        contentDiv.className = 'insight-content';

        const titleEl = document.createElement('div');
        titleEl.className = 'insight-title';
        titleEl.textContent = insight.title;
        contentDiv.appendChild(titleEl);

        const messageEl = document.createElement('div');
        messageEl.className = 'insight-message';
        messageEl.textContent = insight.message;
        contentDiv.appendChild(messageEl);

        card.appendChild(contentDiv);

        // Time
        const timeEl = document.createElement('div');
        timeEl.className = 'insight-time';
        timeEl.textContent = insight.relative_time;
        card.appendChild(timeEl);

        return card;
    }

    // Render error state for insights
    function renderInsightsError(container) {
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        const errorDiv = document.createElement('div');
        errorDiv.className = 'insights-error';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        svg.appendChild(circle);

        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '12');
        line1.setAttribute('y1', '8');
        line1.setAttribute('x2', '12');
        line1.setAttribute('y2', '12');
        svg.appendChild(line1);

        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '12');
        line2.setAttribute('y1', '16');
        line2.setAttribute('x2', '12.01');
        line2.setAttribute('y2', '16');
        svg.appendChild(line2);

        errorDiv.appendChild(svg);

        const span = document.createElement('span');
        span.textContent = 'Unable to load insights';
        errorDiv.appendChild(span);

        container.appendChild(errorDiv);
    }

    // Initialize
    document.getElementById('restart-btn').addEventListener('click', restartContainer);
    document.getElementById('health-score-refresh').addEventListener('click', fetchHealthScore);
    document.getElementById('insights-refresh').addEventListener('click', fetchInsights);

    // Fetch initial data
    fetchContainerStatus();
    fetchHealthScore();
    fetchInsights();

    // Refresh intervals
    setInterval(fetchContainerStatus, 10000);
    setInterval(fetchHealthScore, 60000);  // Refresh health score every minute
    setInterval(fetchInsights, 60000);  // Refresh insights every minute

    // =========================================================================
    // Admin Credentials Vault
    // =========================================================================
    (function() {
        const vault = document.getElementById('credentials-vault');
        if (!vault) return;  // No credentials vault on this page

        const unlockBtn = document.getElementById('vault-unlock-btn');
        const lockBtn = document.getElementById('vault-lock-btn');
        const vaultFooter = vault.querySelector('.vault-footer');
        const countdownEl = document.getElementById('vault-countdown');
        const timerFill = document.getElementById('vault-timer-fill');
        const statusText = vault.querySelector('.vault-status-text');
        const copyButtons = vault.querySelectorAll('.credential-copy');

        let autoLockTimer = null;
        let countdownInterval = null;
        const AUTO_LOCK_SECONDS = 60;

        // Unlock the vault
        function unlockVault() {
            vault.classList.add('unlocked');
            vaultFooter.style.display = 'flex';
            if (statusText) statusText.textContent = 'Unlocked';
            startAutoLockTimer();
        }

        // Lock the vault
        function lockVault() {
            vault.classList.remove('unlocked');
            vaultFooter.style.display = 'none';
            if (statusText) statusText.textContent = 'Secured';
            clearAutoLockTimer();
        }

        // Start auto-lock countdown
        function startAutoLockTimer() {
            clearAutoLockTimer();
            let remaining = AUTO_LOCK_SECONDS;

            // Update UI immediately
            if (countdownEl) countdownEl.textContent = remaining;
            if (timerFill) timerFill.style.width = '100%';

            countdownInterval = setInterval(function() {
                remaining--;
                if (countdownEl) countdownEl.textContent = remaining;
                if (timerFill) {
                    const percent = (remaining / AUTO_LOCK_SECONDS) * 100;
                    timerFill.style.width = percent + '%';
                }

                if (remaining <= 0) {
                    lockVault();
                }
            }, 1000);

            autoLockTimer = setTimeout(function() {
                lockVault();
            }, AUTO_LOCK_SECONDS * 1000);
        }

        // Clear auto-lock timer
        function clearAutoLockTimer() {
            if (autoLockTimer) {
                clearTimeout(autoLockTimer);
                autoLockTimer = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Copy to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(function() {
                // Visual feedback
                button.classList.add('copied');

                // Change icon to checkmark
                const originalSvg = button.innerHTML;
                button.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

                setTimeout(function() {
                    button.classList.remove('copied');
                    button.innerHTML = originalSvg;
                }, 1500);
            }).catch(function(err) {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    button.classList.add('copied');
                    setTimeout(function() {
                        button.classList.remove('copied');
                    }, 1500);
                } catch (e) {
                    console.error('Fallback copy failed:', e);
                }
                document.body.removeChild(textarea);
            });
        }

        // Event listeners
        if (unlockBtn) {
            unlockBtn.addEventListener('click', unlockVault);
        }

        if (lockBtn) {
            lockBtn.addEventListener('click', lockVault);
        }

        // Copy buttons
        copyButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const textToCopy = this.getAttribute('data-copy');
                if (textToCopy) {
                    copyToClipboard(textToCopy, this);
                }
            });
        });

        // Reset timer on interaction within the vault
        vault.addEventListener('click', function(e) {
            if (vault.classList.contains('unlocked') &&
                !e.target.closest('.vault-lock-btn') &&
                !e.target.closest('.vault-unlock-btn')) {
                // Reset timer on any interaction except lock/unlock buttons
                startAutoLockTimer();
            }
        });
    })();
</script>
{% endblock %}
