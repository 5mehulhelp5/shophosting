{% extends "dashboard/base_dashboard.html" %}

{% block page_title %}Site Health{% endblock %}

{% block dashboard_css %}
/* Site Health - Industrial Monitoring Aesthetic */
.health-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: 24px;
    overflow: hidden;
    position: relative;
}

.health-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
}

.health-card-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.health-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.health-card-title svg {
    color: var(--accent-cyan);
}

/* Status Row */
.health-status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 28px;
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.02) 0%, transparent 50%);
    border-bottom: 1px solid var(--border-subtle);
}

.status-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.02em;
}

.status-badge.running {
    background: rgba(34, 197, 94, 0.12);
    color: #4ade80;
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.1);
}

.status-badge.stopped {
    background: rgba(239, 68, 68, 0.12);
    color: #f87171;
}

.status-badge.unknown {
    background: rgba(156, 163, 175, 0.12);
    color: var(--text-secondary);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px currentColor; }
    50% { opacity: 0.6; box-shadow: 0 0 8px currentColor; }
}

.uptime-text {
    color: var(--text-tertiary);
    font-size: 0.9rem;
    font-family: 'JetBrains Mono', monospace;
}

.restart-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.restart-btn:hover:not(:disabled) {
    background: var(--bg-elevated);
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
}

.restart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Metrics Grid */
.health-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0;
    border-bottom: 1px solid var(--border-subtle);
}

.metric-panel {
    padding: 24px;
    border-right: 1px solid var(--border-subtle);
    position: relative;
    overflow: hidden;
}

.metric-panel:last-child {
    border-right: none;
}

.metric-panel::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 24px;
    right: 24px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
}

.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.metric-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
}

.metric-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1;
}

.metric-value.cpu { color: var(--accent-cyan); }
.metric-value.memory { color: #a78bfa; }
.metric-value.network { color: #4ade80; }

.metric-value .unit {
    font-size: 0.875rem;
    font-weight: 400;
    color: var(--text-muted);
    margin-left: 2px;
}

.metric-subtext {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
    font-family: 'JetBrains Mono', monospace;
}

/* Sparkline Charts */
.metric-chart {
    height: 48px;
    margin-top: 12px;
    position: relative;
}

.metric-chart canvas {
    width: 100% !important;
    height: 100% !important;
}

/* Progress bar style for memory */
.metric-progress {
    height: 6px;
    background: var(--bg-deep);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
}

.metric-progress-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
    background: linear-gradient(90deg, #a78bfa, #c4b5fd);
}

/* Network stats */
.network-stats {
    display: flex;
    gap: 20px;
    margin-top: 8px;
}

.network-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.network-stat svg {
    width: 14px;
    height: 14px;
}

.network-stat.rx svg { color: #4ade80; }
.network-stat.tx svg { color: #60a5fa; }

.network-stat .rate {
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-primary);
}

/* Logs Section */
.logs-section {
    padding: 0;
}

.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 28px;
    cursor: pointer;
    transition: background 0.15s;
}

.logs-header:hover {
    background: rgba(255, 255, 255, 0.02);
}

.logs-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.logs-title svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
}

.logs-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.logs-toggle-icon {
    transition: transform 0.2s;
    color: var(--text-muted);
}

.logs-toggle-icon.expanded {
    transform: rotate(180deg);
}

.logs-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.logs-content.expanded {
    max-height: 350px;
    overflow-y: auto;
}

.logs-list {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    padding: 0;
    background: var(--bg-deepest);
    margin: 0;
    line-height: 1.6;
}

.log-line {
    padding: 6px 28px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    color: var(--text-tertiary);
    transition: background 0.1s;
}

.log-line:hover {
    background: rgba(255, 255, 255, 0.02);
    color: var(--text-secondary);
}

.log-line:last-child {
    border-bottom: none;
}

/* Scrollbar styling */
.logs-content::-webkit-scrollbar {
    width: 6px;
}

.logs-content::-webkit-scrollbar-track {
    background: var(--bg-deepest);
}

.logs-content::-webkit-scrollbar-thumb {
    background: var(--bg-hover);
    border-radius: 3px;
}

/* Loading state */
.metric-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 48px;
    color: var(--text-muted);
    font-size: 0.8rem;
}

.metric-loading::after {
    content: '';
    width: 16px;
    height: 16px;
    margin-left: 8px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-cyan);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 900px) {
    .health-metrics {
        grid-template-columns: 1fr;
    }

    .metric-panel {
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
    }

    .metric-panel:last-child {
        border-bottom: none;
    }
}

@media (max-width: 640px) {
    .health-status-row {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }

    .metric-panel {
        padding: 20px;
    }
}
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Site Health</h1>
    <p class="page-subtitle">Real-time monitoring of your store's performance and resources.</p>
</div>

<div class="health-card">
    <div class="health-card-header">
        <h2 class="health-card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Container Status
        </h2>
    </div>

    <div class="health-status-row">
        <div class="status-info">
            <span id="container-status" class="status-badge unknown">
                <span class="status-dot"></span>
                <span class="status-text">Checking...</span>
            </span>
            <span id="container-uptime" class="uptime-text"></span>
        </div>
        <button id="restart-btn" class="restart-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Restart Store
        </button>
    </div>

    <div class="health-metrics">
        <!-- CPU Panel -->
        <div class="metric-panel">
            <div class="metric-header">
                <div>
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value cpu" id="cpu-value">--<span class="unit">%</span></div>
                </div>
            </div>
            <div class="metric-chart" id="cpu-chart">
                <canvas id="cpu-canvas"></canvas>
            </div>
        </div>

        <!-- Memory Panel -->
        <div class="metric-panel">
            <div class="metric-header">
                <div>
                    <div class="metric-label">Memory</div>
                    <div class="metric-value memory" id="memory-value">--<span class="unit">%</span></div>
                    <div class="metric-subtext" id="memory-detail">-- / -- MB</div>
                </div>
            </div>
            <div class="metric-progress">
                <div class="metric-progress-bar" id="memory-bar" style="width: 0%"></div>
            </div>
            <div class="metric-chart" id="memory-chart">
                <canvas id="memory-canvas"></canvas>
            </div>
        </div>

        <!-- Network Panel -->
        <div class="metric-panel">
            <div class="metric-header">
                <div>
                    <div class="metric-label">Network I/O</div>
                    <div class="network-stats">
                        <div class="network-stat rx">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 19V5M5 12l7-7 7 7"/>
                            </svg>
                            <span class="rate" id="net-rx">--</span>
                        </div>
                        <div class="network-stat tx">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M19 12l-7 7-7-7"/>
                            </svg>
                            <span class="rate" id="net-tx">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="metric-chart" id="network-chart">
                <canvas id="network-canvas"></canvas>
            </div>
        </div>
    </div>

    <div class="logs-section">
        <div id="logs-header" class="logs-header">
            <span class="logs-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Recent Logs
            </span>
            <div class="logs-controls">
                <button id="refresh-logs-btn" class="restart-btn" style="padding: 6px 12px; font-size: 0.8rem;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh
                </button>
                <svg id="logs-toggle" class="logs-toggle-icon expanded" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
        </div>
        <div id="logs-content" class="logs-content expanded">
            <div id="logs-list" class="logs-list">
                <div class="log-line">Loading logs...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js_block %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" nonce="{{ csp_nonce() }}"></script>
<script nonce="{{ csp_nonce() }}">
    let restartCooldown = false;
    let logsExpanded = true;
    let cpuChart, memoryChart, networkChart;

    // Chart.js default configuration for sparklines
    const sparklineConfig = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            scales: {
                x: { display: false },
                y: {
                    display: false,
                    beginAtZero: true
                }
            },
            elements: {
                point: { radius: 0 },
                line: {
                    tension: 0.4,
                    borderWidth: 2
                }
            },
            animation: {
                duration: 500
            }
        }
    };

    function initCharts() {
        // CPU Chart - Cyan
        const cpuCtx = document.getElementById('cpu-canvas').getContext('2d');
        cpuChart = new Chart(cpuCtx, {
            ...sparklineConfig,
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    data: Array(30).fill(0),
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    fill: true
                }]
            }
        });
        cpuChart.options.scales.y.max = 100;

        // Memory Chart - Purple
        const memCtx = document.getElementById('memory-canvas').getContext('2d');
        memoryChart = new Chart(memCtx, {
            ...sparklineConfig,
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    data: Array(30).fill(0),
                    borderColor: '#a78bfa',
                    backgroundColor: 'rgba(167, 139, 250, 0.1)',
                    fill: true
                }]
            }
        });
        memoryChart.options.scales.y.max = 100;

        // Network Chart - Green/Blue dual
        const netCtx = document.getElementById('network-canvas').getContext('2d');
        networkChart = new Chart(netCtx, {
            ...sparklineConfig,
            data: {
                labels: Array(30).fill(''),
                datasets: [
                    {
                        data: Array(30).fill(0),
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.05)',
                        fill: true
                    },
                    {
                        data: Array(30).fill(0),
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.05)',
                        fill: true
                    }
                ]
            }
        });
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B/s';
        const k = 1024;
        const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function fetchMetrics() {
        try {
            const response = await fetch('/api/container/metrics', { credentials: 'same-origin' });
            if (!response.ok) return;

            const data = await response.json();

            // Update CPU - use DOM methods for safety
            const cpuValueEl = document.getElementById('cpu-value');
            cpuValueEl.textContent = '';
            cpuValueEl.appendChild(document.createTextNode(data.cpu.current));
            const cpuUnit = document.createElement('span');
            cpuUnit.className = 'unit';
            cpuUnit.textContent = '%';
            cpuValueEl.appendChild(cpuUnit);

            if (cpuChart && data.cpu.data.length) {
                cpuChart.data.datasets[0].data = data.cpu.data;
                cpuChart.update('none');
            }

            // Update Memory
            const memValueEl = document.getElementById('memory-value');
            memValueEl.textContent = '';
            memValueEl.appendChild(document.createTextNode(data.memory.current));
            const memUnit = document.createElement('span');
            memUnit.className = 'unit';
            memUnit.textContent = '%';
            memValueEl.appendChild(memUnit);

            document.getElementById('memory-detail').textContent =
                Math.round(data.memory.used_mb) + ' / ' + Math.round(data.memory.limit_mb) + ' MB';
            document.getElementById('memory-bar').style.width = data.memory.current + '%';

            if (memoryChart && data.memory.data.length) {
                memoryChart.data.datasets[0].data = data.memory.data;
                memoryChart.update('none');
            }

            // Update Network
            document.getElementById('net-rx').textContent = formatBytes(data.network.rx_bytes_sec);
            document.getElementById('net-tx').textContent = formatBytes(data.network.tx_bytes_sec);

            if (networkChart && data.network.rx_data.length) {
                networkChart.data.datasets[0].data = data.network.rx_data;
                networkChart.data.datasets[1].data = data.network.tx_data;
                networkChart.update('none');
            }
        } catch (error) {
            console.error('Failed to fetch metrics:', error);
        }
    }

    async function fetchContainerStatus() {
        const statusEl = document.getElementById('container-status');
        const uptimeEl = document.getElementById('container-uptime');
        const statusText = statusEl.querySelector('.status-text');

        try {
            const response = await fetch('/api/container/status', { credentials: 'same-origin' });
            if (!response.ok) {
                statusEl.className = 'status-badge unknown';
                statusText.textContent = 'Error';
                uptimeEl.textContent = '';
                return;
            }

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                statusEl.className = 'status-badge unknown';
                statusText.textContent = 'Error';
                uptimeEl.textContent = '';
                return;
            }

            const data = await response.json();
            statusEl.className = 'status-badge ' + (data.running ? 'running' :
                data.status === 'exited' ? 'stopped' : 'unknown');
            statusText.textContent = data.running ? 'Running' :
                data.status === 'exited' ? 'Stopped' : 'Unknown';
            uptimeEl.textContent = data.uptime ? data.uptime : '';
        } catch (error) {
            console.error('Failed to fetch container status:', error);
            statusEl.className = 'status-badge unknown';
            statusText.textContent = 'Error';
            uptimeEl.textContent = '';
        }
    }

    async function restartContainer() {
        if (restartCooldown) {
            alert('Please wait 5 minutes between restarts.');
            return;
        }
        if (!confirm('Restart your store? It will be unavailable for ~30 seconds.')) return;

        const btn = document.getElementById('restart-btn');
        btn.disabled = true;

        try {
            const response = await fetch('/api/container/restart', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                restartCooldown = true;
                setTimeout(() => { restartCooldown = false; btn.disabled = false; }, 300000);
                setTimeout(fetchContainerStatus, 5000);
            } else {
                alert('Restart failed: ' + data.message);
                btn.disabled = false;
            }
        } catch (error) {
            alert('Failed to restart: ' + error.message);
            btn.disabled = false;
        }
    }

    function toggleLogs() {
        logsExpanded = !logsExpanded;
        document.getElementById('logs-content').classList.toggle('expanded', logsExpanded);
        document.getElementById('logs-toggle').classList.toggle('expanded', logsExpanded);
        if (logsExpanded) refreshLogs();
    }

    async function refreshLogs() {
        const logsEl = document.getElementById('logs-list');
        // Clear existing content safely
        while (logsEl.firstChild) {
            logsEl.removeChild(logsEl.firstChild);
        }
        const loadingLine = document.createElement('div');
        loadingLine.className = 'log-line';
        loadingLine.textContent = 'Loading logs...';
        logsEl.appendChild(loadingLine);

        try {
            const response = await fetch('/api/container/logs?lines=50', { credentials: 'same-origin' });
            const data = await response.json();

            // Clear loading message
            while (logsEl.firstChild) {
                logsEl.removeChild(logsEl.firstChild);
            }

            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(line => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'log-line';
                    lineDiv.textContent = line;
                    logsEl.appendChild(lineDiv);
                });
            } else {
                const emptyLine = document.createElement('div');
                emptyLine.className = 'log-line';
                emptyLine.textContent = 'No recent logs.';
                logsEl.appendChild(emptyLine);
            }
        } catch (error) {
            while (logsEl.firstChild) {
                logsEl.removeChild(logsEl.firstChild);
            }
            const errorLine = document.createElement('div');
            errorLine.className = 'log-line';
            errorLine.style.color = 'var(--error)';
            errorLine.textContent = 'Failed to load logs.';
            logsEl.appendChild(errorLine);
        }
    }

    // Event listeners
    document.getElementById('restart-btn').addEventListener('click', restartContainer);
    document.getElementById('logs-header').addEventListener('click', toggleLogs);
    document.getElementById('refresh-logs-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        refreshLogs();
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        fetchContainerStatus();
        fetchMetrics();
        refreshLogs();

        // Refresh intervals
        setInterval(fetchContainerStatus, 10000);
        setInterval(fetchMetrics, 15000);
    });
</script>
{% endblock %}
