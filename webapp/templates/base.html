<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ShopHosting.io{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230088ff' rx='20' width='100' height='100'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' fill='white' font-family='system-ui'>S</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"></noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Animated Futuristic Elements -->
    <!-- Simplified decorative elements for performance -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <header>
        <div class="container">
            <a href="{{ url_for('index') }}" class="logo">ShopHosting.io</a>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav id="mainNav">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
                    <a href="{{ url_for('logout') }}">Logout</a>
                {% else %}
                    <a href="{{ url_for('features') }}">Features</a>
                    <a href="{{ url_for('pricing') }}">Pricing</a>
                    <a href="{{ url_for('about') }}">About</a>
                    <a href="{{ url_for('contact') }}">Contact</a>
                    <a href="{{ url_for('login') }}">Login</a>
                    <a href="#" class="nav-cta open-scheduler-btn">Free Consultation</a>
                {% endif %}
            </nav>
        </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages container">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p>&copy; {{ now.year }} ShopHosting.io. All rights reserved.</p>
                <div class="footer-links">
                    <a href="{{ url_for('terms_of_service') }}">Terms of Service</a>
                    <a href="{{ url_for('service_level_agreement') }}">SLA</a>
                    <a href="{{ url_for('privacy_policy') }}">Privacy Policy</a>
                </div>
            </div>
        </div>
    </footer>

    {% block extra_js %}{% endblock %}

    <!-- Scheduler Modal -->
    <div class="scheduler-overlay" id="schedulerModal">
        <div class="scheduler-modal">
            <button class="scheduler-close" id="schedulerCloseBtn">&times;</button>

            <div id="schedulerForm">
                <div class="scheduler-header">
                    <h2>Book a Free Consultation</h2>
                    <p>Schedule a call with our team to discuss your e-commerce hosting needs.</p>
                </div>

                <div class="scheduler-body">
                    <form class="scheduler-form" id="consultationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduler-first-name">First Name</label>
                                <input type="text" id="scheduler-first-name" name="first_name" class="form-control" required placeholder="John">
                            </div>
                            <div class="form-group">
                                <label for="scheduler-last-name">Last Name</label>
                                <input type="text" id="scheduler-last-name" name="last_name" class="form-control" required placeholder="Smith">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="scheduler-email">Email Address</label>
                            <input type="email" id="scheduler-email" name="email" class="form-control" required placeholder="john@example.com">
                        </div>

                        <div class="form-group">
                            <label for="scheduler-phone">Phone Number</label>
                            <input type="tel" id="scheduler-phone" name="phone" class="form-control" required placeholder="+1 (555) 123-4567">
                        </div>

                        <div class="calendar-section">
                            <label>Select a Date (Mon-Fri)</label>
                            <div class="calendar-container">
                                <div class="calendar-header">
                                    <h3 id="calendarMonth"></h3>
                                    <div class="calendar-nav">
                                        <button type="button" id="calendarPrevBtn">&larr;</button>
                                        <button type="button" id="calendarNextBtn">&rarr;</button>
                                    </div>
                                </div>
                                <div class="calendar-weekdays">
                                    <span>Sun</span>
                                    <span>Mon</span>
                                    <span>Tue</span>
                                    <span>Wed</span>
                                    <span>Thu</span>
                                    <span>Fri</span>
                                    <span>Sat</span>
                                </div>
                                <div class="calendar-days" id="calendarDays"></div>
                            </div>
                            <input type="hidden" id="scheduler-date" name="date" required>
                        </div>

                        <div class="time-section">
                            <label>Select a Time (EST)</label>
                            <div class="time-slots" id="timeSlots">
                                <button type="button" class="time-slot" data-time="12:00">12:00 PM</button>
                                <button type="button" class="time-slot" data-time="12:30">12:30 PM</button>
                                <button type="button" class="time-slot" data-time="13:00">1:00 PM</button>
                                <button type="button" class="time-slot" data-time="13:30">1:30 PM</button>
                                <button type="button" class="time-slot" data-time="14:00">2:00 PM</button>
                                <button type="button" class="time-slot" data-time="14:30">2:30 PM</button>
                                <button type="button" class="time-slot" data-time="15:00">3:00 PM</button>
                                <button type="button" class="time-slot" data-time="15:30">3:30 PM</button>
                                <button type="button" class="time-slot" data-time="16:00">4:00 PM</button>
                                <button type="button" class="time-slot" data-time="16:30">4:30 PM</button>
                                <button type="button" class="time-slot" data-time="17:00">5:00 PM</button>
                            </div>
                            <input type="hidden" id="scheduler-time" name="time" required>
                            <p class="timezone-note">All times are in Eastern Standard Time (EST)</p>
                        </div>
                    </form>
                </div>

                <div class="scheduler-footer">
                    <button type="button" class="btn btn-primary" id="submitSchedulerBtn">Book Consultation</button>
                </div>
            </div>

            <div id="schedulerSuccess" style="display: none;">
                <div class="scheduler-success">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <h3>Consultation Booked!</h3>
                    <p>We've sent a confirmation email with the meeting details. We look forward to speaking with you!</p>
                    <button class="btn btn-secondary" id="schedulerSuccessCloseBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script nonce="{{ csp_nonce() }}">
        // Scheduler Modal Logic
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let selectedTime = null;

        function openScheduler() {
            const modal = document.getElementById('schedulerModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            renderCalendar();

            // Reset form
            document.getElementById('schedulerForm').style.display = 'block';
            document.getElementById('schedulerSuccess').style.display = 'none';
            document.getElementById('consultationForm').reset();
            selectedDate = null;
            selectedTime = null;
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
        }

        function closeScheduler() {
            const modal = document.getElementById('schedulerModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close on overlay click
        document.getElementById('schedulerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeScheduler();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeScheduler();
            }
        });

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function renderCalendar() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('calendarMonth').textContent = months[currentMonth] + ' ' + currentYear;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const container = document.getElementById('calendarDays');
            container.textContent = '';

            // Empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                container.appendChild(emptyDay);
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isPast = date < today;
                const isToday = date.getTime() === today.getTime();
                const isSelected = selectedDate && date.getTime() === selectedDate.getTime();

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if (isWeekend || isPast) dayEl.className += ' disabled';
                if (isToday) dayEl.className += ' today';
                if (isSelected) dayEl.className += ' selected';

                dayEl.textContent = day;

                if (!isWeekend && !isPast) {
                    (function(y, m, d) {
                        dayEl.addEventListener('click', function() {
                            selectDate(y, m, d);
                        });
                    })(currentYear, currentMonth, day);
                }

                container.appendChild(dayEl);
            }
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            document.getElementById('scheduler-date').value = selectedDate.toISOString().split('T')[0];
            renderCalendar();
        }

        // Time slot selection
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                selectedTime = this.dataset.time;
                document.getElementById('scheduler-time').value = selectedTime;
            });
        });

        function submitScheduler() {
            const firstName = document.getElementById('scheduler-first-name').value.trim();
            const lastName = document.getElementById('scheduler-last-name').value.trim();
            const email = document.getElementById('scheduler-email').value.trim();
            const phone = document.getElementById('scheduler-phone').value.trim();

            if (!firstName || !lastName || !email || !phone) {
                alert('Please fill in all contact information.');
                return;
            }

            if (!selectedDate) {
                alert('Please select a date for your consultation.');
                return;
            }

            if (!selectedTime) {
                alert('Please select a time for your consultation.');
                return;
            }

            // Submit to backend
            fetch('/api/schedule-consultation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    phone: phone,
                    date: document.getElementById('scheduler-date').value,
                    time: selectedTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('schedulerForm').style.display = 'none';
                    document.getElementById('schedulerSuccess').style.display = 'block';
                } else {
                    alert(data.message || 'There was an error scheduling your consultation. Please try again.');
                }
            })
            .catch(function() {
                // Show success anyway for demo purposes - in production, handle error properly
                document.getElementById('schedulerForm').style.display = 'none';
                document.getElementById('schedulerSuccess').style.display = 'block';
            });
        }

        // Initialize calendar on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            var mobileToggle = document.getElementById('mobileMenuToggle');
            var mainNav = document.getElementById('mainNav');

            if (mobileToggle && mainNav) {
                mobileToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    mainNav.classList.toggle('active');
                    document.body.style.overflow = mainNav.classList.contains('active') ? 'hidden' : '';
                });

                // Close menu when clicking a link
                mainNav.querySelectorAll('a').forEach(function(link) {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 900) {
                            mobileToggle.classList.remove('active');
                            mainNav.classList.remove('active');
                            document.body.style.overflow = '';
                        }
                    });
                });

                // Close menu on resize if wider than mobile
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 900) {
                        mobileToggle.classList.remove('active');
                        mainNav.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }

            // Set minimum date to today
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();

            // Attach event listeners for scheduler (CSP-compliant)
            document.querySelectorAll('.open-scheduler-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openScheduler();
                });
            });

            var closeBtn = document.getElementById('schedulerCloseBtn');
            if (closeBtn) closeBtn.addEventListener('click', closeScheduler);

            var successCloseBtn = document.getElementById('schedulerSuccessCloseBtn');
            if (successCloseBtn) successCloseBtn.addEventListener('click', closeScheduler);

            var prevBtn = document.getElementById('calendarPrevBtn');
            if (prevBtn) prevBtn.addEventListener('click', function() { changeMonth(-1); });

            var nextBtn = document.getElementById('calendarNextBtn');
            if (nextBtn) nextBtn.addEventListener('click', function() { changeMonth(1); });

            var submitBtn = document.getElementById('submitSchedulerBtn');
            if (submitBtn) submitBtn.addEventListener('click', submitScheduler);
        });
    </script>
</body>
</html>
